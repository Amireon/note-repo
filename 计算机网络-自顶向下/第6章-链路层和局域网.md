> 网络层解决了一个网络如何到达另一个网络的路由问题
> 在一个网络内部如何由一个节点（主机或路由器）到达另外一个相邻节点
> 链路层的点到点传输层功能

**链路层学习目标**
1.理解数据链路层服务的原理
- 检错和纠错
- 共享广播信道：多点接入（多路访问）
- 链路层寻址
- LAN：以太网，WLAN，VLANS
- 可靠数据传输，流控制

2.实例和各种链路层技术的实现

网络节点的连接方式
点到点连接
多点连接：共享型介质，通过网络交换层

## 6.1 引论和服务
- 主机和路由器是节点（网桥和交换机也是）：nodes
- 沿着通信路径,连接个相邻节点通信信道的是链路：links
	- 有线链路
	- 无线链路
	- 局域网，共享性链路
- 第二层协议数据单元帧frame，封装数据报

数据链路层负责从一个节点通过链路将（帧中的）数据报发送到相邻的物理节点（一个子网内的2节点）

**链路层：上下文**
数据报（分组）在不同的链路上以不同的链路协议传送：
- 第一条链路：以太网
- 中间链路：帧中继链路
- 最后一跳：802.11

不同的链路协议提供不同的服务

**2.链路层服务**
一般化的链路层服务，不是所有的链路层都提供这些服务
一个特定的链路层只是提供其中一部分的服务

`成帧，链路接入`:
- 将数据报封装在帧中，加上帧头，帧尾部
- 如果采用共享性介质，信道接入获得信道访问权
- 在帧头部使用MAC地址标示源和目的

`在相邻两个节点完成可靠数据传输`
- 在低出错率的链路上（光纤和双绞线电缆）很少使用
- 在无线链路经常使用：出错率高

`在相邻节点间（一个子网内）进行可靠的转发`

`流量控制`：使得相邻的发送和接收方节点的速度匹配

` 错误检测`：
- 差错由信号衰减和噪声引起
- 接收方检测出的错误：通知发送端进行重传或丢弃帧

`差错纠正`: 接收端检查和纠正bit错误，不通过重传来纠正错误

`半双工和全双工`: 半双工：链路可以双向传输，但一次只有一个方向

**Q1：链路层在哪实现？**
- 在每一个主机/路由器，交换机的每个端口上
- 链路层功能在“适配器”上实现(aka network interface card NIC) 或者在一个芯片组上
	- 以太网卡，802.11 网卡; 以太网芯片组
	- 实现链路层和相应的物理层功能
- 接到主机的系统总线上
- 硬件、软件和固件的综合体

**适配器通信**
- 发送方：在帧中封装数据报；加上差错控制编码，实现RDT和流量控制功能等
- 接收方：检查有无出错，执行RDT和流量控制功能；解封装数据报，交给上层

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101716092.png)

## 6.2 差错检测和纠正
错误检测
- EDC = 差错检测和纠正位（冗余位）
- D = 数据由差错检测保护，可以包含头部字段
- 协议会漏检一些错误，但是很少
- 更长的EDC字段可以得到更好的检测和纠正效果

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101721640.png)

**1.奇偶校验**

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101722128.png)

**2.Internet校验和**
目标：检测在传输报文段时的错误，仅作用在传输层

发送方：
- 将报文段看成16-bit整数
- 报文段的校验和: 和(1’的补码和)
- 发送方将checksum的值放在‘UDP校验和’字段

接收方:
- 计算接收到的报文段的校验和
- 检查是否与携带校验和字段值一致:
	- 不一致：检出错误
	 - 一致：没有检出错误，但可能还是有错误

**3.检验和：CRC（循环冗余校验）**
强大的差错检测码
- 将数据比特D, 看成是二进制的数据
- 生成多项式G：双方协商r+1位模式（r次方）
- 生成和检查所使用的位模式
- 目标:选择r位CRC附加位R，使得
- <D,R> 正好被G整除(modulo 2)
- 接收方知道G, 将<D,R>除以G. 如果非0余数: 检查出错误!
- 能检出所有少于r+1位的突发错误
- 实际中广泛使用（以太网、802.11 WiFi、ATM）

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101725158.png)

**CRC性能分析**
突发错误和突发长度

CRC检错性能描述
- 能够检查出所有的1bit错误
- 能够检查出所有的双bits的错误
- 能够检查出所有长度=r或者<r 位的错误
- 出现长度为r+1的突发错误，检查不出的概率是 $1/2^{r-1}$
- 出现长度大于r+1的突发错误，检查不出的概率是 $1/2^{r}$


## 6.3 多点访问协议
两种类型的链路（一个子网内部链路连接形式）：
- 点对点：拨号访问的PPP；以太网交换机和主机之间的点对点链路
- 广播(共享线路或媒体)：传统以太网，HFC上行链路，802.11无线局域网

### 1.多路访问协议
- 单个共享的广播型链路
- 2个或更多站点同时传送：冲突collision，多个节点在同一时刻发送，会收到多个信号叠加

**多路访问协议（介质访问控制协议：MAC）**
- 分布式算法-决定节点如何使用共享信道，即：决定节点什么时候可以发送？
- 关于共享控制的通信必须用借助信道本身传输！
	- 没有带外的信道，各节点使用其协调信道使用
	- 用于传输控制信息

**1.理想的多路访问协议**
给定：RBps的广播信道
必要条件：
- 当一个节点要发送时，可以R速率发送.
- 当M个节点要发送，每个可以以R/M的平均速率发送
- 完全分布的: 没有特殊节点协调发送； 没有时钟和时隙的同步

**2.MAC(媒体访问控制)协议：分类**
`信道划分`：
- 把信道划分为小片，时间、编码、频率
- 分配片给每个节点专用

`随机访问`
- 信道不划分，允许冲突
- 冲突后恢复

`依次轮流`
- 节点依次轮流
- 有很多数据传输的节点可以获得较长的信道使用权

### 2.信道划分MAC协议
**1.信道划分MAC协议：TDMA**
TDMA：time division multiple access
- 轮流使用信道，信道的时间分为周期
- 每个站点使用每周期中固定的时隙(长度=帧传输时间)传输帧
- 如果站点无帧传输，时隙空闲-》浪费
- 如：6站LAN，1、3、4有数据报，时隙2、5、6空闲

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101739792.png)

**2.信道划分MAC协议：FDMA**
FDMA: frequency division multiple access
- 信道的有效频率范围被分成一个个小的频段
- 每个站点被分配一个固定的频段
- 分配给站点的频段如果没有被使用，则空闲
- 例如：6站LAN，1、3、4有数据报，频段2、5、6空闲

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101740038.png)


**3.码分多路访问（CDMA）**
CDMA (code division multiple access) :
• 所有站点在整个频段上同时进行传输, 采用编码原理加以区分
• 完全无冲突
• 假定:信号同步很好,线性叠加

**4.随机存取协议**
当节点有帧要发送时
- 以信道带宽的全部R bps发送
- 没有节点间的预先协调
- 两个或更多节点同时传输，会发生➜冲突“collision”

随机存取协议规定:
- 如何检测冲突
- 如何从冲突中恢复（如：通过稍后的重传）

随机MAC协议:
- 时隙ALOHA
- ALOHA
- CSMA, CSMA/CD, CSMA/CA

### 3.ALOHA
**1.时隙ALOHA**
假设
- 所有帧是等长的
- 时间被划分成相等的时隙，每个时隙可发送一帧
- 节点只在时隙开始时发送帧
- 节点在时钟上是同步的
- 如果两个或多个节点在一个时隙传输，所有的站点都能检测到冲突

运行
- 当节点获取新的帧，在下一个时隙传输
- 传输时没有检测到冲突，成功， 节点能够在下一时隙发送新帧
- 检测时如果检测到冲突，失败
- 节点在每一个随后的时隙以概率p重传帧直到成功

优点
- 节点可以以信道带宽全速连续传输
- 高度分布：仅需要节点之间在时隙上的同步
- 简单

缺点
- 存在冲突，浪费时隙
- 即使有帧要发送，仍然有可能存在空闲的时隙
- 节点检测冲突的时间 < 帧传输的时间，必须传完
- 需要时钟上同步

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101745494.png)

**时隙ALOHA的效率( Efficiency )**
>效率：当有很多节点，每个节点有很多帧要发送时，x%的时隙是成功传输帧的时隙

Q1：假设N个节点，每个节点都有很多帧要发送，在每个时隙中的传输概率是p
- 一个节点成功传输概率是 $p(1-p)^{N-1}$
- 任何一个节点的成功概率是 $Np(1-p)^{N-1}$

Q2：N个节点的最大效率
- N为无穷大时的极限为 1/e=0.37

#### 纯ALOHA
- 无时隙ALOHA：简单、无须节点间在时间上同步
- 当有帧需要传输：马上传输
- 冲突的概率增加:
	- 帧在t0发送，和其它在[t0 -1, t0 +1]区间内开始发送的帧冲突
	- 和当前帧冲突的区间（其他帧在此区间开始传输）增大了一倍

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301101752122.png)

**纯ALOHA的效率**
P(指定节点成功) = P(节点传输) * P(其它节点在[t0-1, t0]不传) * P(其它节点在[t0, t0+1不传])
= $p . (1-p)^{N-1} . (1-p)^{N-1} = p . (1-p)^{2(N-1)}$

选择最佳的p、N趋向无穷大，计算的 1/(2e) = 17.5%

效率比时隙ALOHA更差了!

