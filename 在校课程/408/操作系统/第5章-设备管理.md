![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301191941931.png)

## 5.1 I/O概述
“I/O”就是“输入/输出”（Input/Output）
I/O 设备可以将数据输入到计算机，或接收计算机输出数据的外部设备，属于计算机中的硬件部件。

**按使用特性分类**
- 人机交互类外部设备：数据传输速度慢
- 存储设备：数据专输速度快
- 网络通信设备：数据传输速度介于上述二者之间

**信息交换单位**
- 块设备：传输速率较高，可寻址，可随机读写
- 字符设备：传输速率较慢，不可寻址，在输入/输出时常采用中断驱动方式


## 5.2 I/O控制器
- I/O设备的机械部件主要用来执行具体I/O操作。
- I/O设备的电子部件通常是一块插入主板扩充槽的印刷电路板

CPU无法直接控制I/O设备的机械部件，因此I/O设备还要有一个电子部件作为CPU和I/O设备机械部件之间的中介，用于实现CPU对设备的控制。
这个电子部件就是I/0控制器，又称设备控制器。
CPU可控制I/O控制器，又由I/0控制器来控制设备的机械部件。

**I/O控制器的功能**
- 接收和识别CPU发出的命令：CPU发来的read/write命令，I/0控制器中会有相应的控制寄存器来存放命令和参数
- 向CPU报告设备状态：I/O控制器中会有相应的状态寄存器用于记录I/O设备的当前状态。如1表示空闲，0表示忙绿
- 数据交换：I/O控制器中会设置相应的数据寄存器。输出时数据奇存器用于暂存CPU发来的数据，之后再由搭制器传送设备。输入时，数据寄存器用于暂存设备发来的数据，之后CPU从数据奇存器中取走数据
- 地址识别: 类似于内存的地地，为了区分设备控制器中的各个寄存器，也需要给各个寄存器设置一个特定的地址。I/O控制器通过CPU提供的地址来判断CPU要读/写的是哪个寄存器

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301191954383.png)

值得注意的小细节：
- 一个I/0控制器可能会对应多个设备
- 数据寄存器、控制寄存器、状态寄存器可能有多个。有的计算机会让这些寄存器占用内存地址的一部分，称为内存映像I/O，另一些计算机则采用I/O专用地址，即寄存器独立编址。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301191957159.png)

## 5.3 I/O控制方式
- 程序直接控制方式
- 中断驱动方式
- DMA方式
- 通道控制方式

关注点：
- 完成一次读/写操作的流程
- CPU于预的频率
- 数据传送的单位
- 数据的流向
- 缺点和优点

**1.程序直接控制方式**
轮询

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192017764.png)


![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192020326.png)

**2.中断驱动方式**
引入中断机制。由于I/O设备速度很慢，因此在CPU发出读/写命令后，可将等待I/O的进程阻塞，先切换到别的进程执行。
当I/0完成后，控制器会向CPU发出一个中断信号，CPU检测到中断信号后，会保存当前进程的运行环境信息，转去执行中断处理程序处理该中断。
处理中断的过程中，CPU从I/O控制器读一个字的数据传送到CPU奇存器，冉写入主存。
接看，CPU恢复等待I/O的进程（或其他进程）的运行环境，然后继续执行

- CPU会在每个指令周期的末尾检查中断
- 中断处理过程中需要保存、恢复进程的运行环境,这个过程是需要一定时间开销的。可见，如果中断发生的频率太高，也会降低系统性能

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192023237.png)

**3.DMA方式**
与“中断驱动方式”相比，DMA方式（Direct Memory Access，直接存储器存取。主要用于块设备的
/0控制）有这样几个改进:
- 数据的传送单位是块，不再是字
- 数据的流向是从设备直接放入内存，或者从内存直接到设备。不冉需要CPU作为“快递小哥”。
- 仅在传送一个或多个数据块的开始和结束时，才需要CPU干预

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192031792.png)

- DR：Data Register，数据寄存器，暂存从设备到内存，或从内存到设备的数据
- MAR：Memory Address Register，内存地址寄存器，在输入时，MAR表示数据应放到内存中的什么位置；输出时MAR表示要输出的数据放在内存中的什么位置
- DC：Data_Counter，数据计数器，表示剩余要读/写的字节数
- CR：Command Register，命令/状态寄存器，用于存放CPU发送的I/O命令，或设备的状态信息

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192057374.png)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192059832.png)

**4.通道控制方式**
通道：属于硬件，弱化版的CPU，
- 通道可以识别并执行一系列通道指令
- 与CPU相比，通道可以执行的指令很单一
- 通道程序是放在主机内存中的，即通道与CPU共享内存

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192100170.png)


![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301192102578.png)

## 5.4 I/O软件层次结构

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301201036378.png)

**1.用户层软件**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301201038950.png)

**2.设备独立性软件**
设备独立性软件：又称设备无关性软件，与设备的硬件特性无关的功能都在这一层实现
实现的功能：
- 向上层提供统一的调用接口
- 差错处理
- 设备的分配与回收
- 数据缓冲区管理：屏蔽设备之间数据交换大小和传输速度的差异
- 建立逻辑设备名到物理设备名的映射关系；根据设备类型算则调用相应驱动程序

操作系统采用两种方式管理逻辑设备表（LUT）：
- 整个系统只有一张LUT：逻辑设备名不能重名，适用于单用户操作系统
- 为每个用户设置一张LUT：各个用户的逻辑设备名可以重名，适用于多用户操作系统，系统为用户建立用户管理进程，该进程的PCB存放着LUT

**3.设备驱动程序**
主要负责对使件设备的具体控制，将层发出的一系列命令（read/write）转化成特定设备“能听得懂”的一系列操作。包括设置设备奇存器，检查设备状态等

不同的I/0设备有不同的硬件特性，具体细节只有设备的厂家才知道，因此厂家需要根据设备的便件特性设计并提供相应的驱动程序

**4.中断处理程序**
当I/O任务完成时，I/O控制器会发送一个中断信号，系统会根据中断信号类型找到相应的中断处理程序并执行。中断处理程序的处理流程如下:

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301201057418.png)

## 5.5 I/O核心子系统
操作系统的内核部分即I/O系统(I/O子系统)：设备独立性软件、设备驱动程序、中断处理程序
重点内容：I/O调度、设备保护、假脱机技术(SPOOLing)、设备分配与回收、缓冲区管理

### 1.假脱机技术
- 脱机：脱离主机的控制进行的输入/输出操作
- 假脱机：SPOOLing，用软件模拟脱机

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301201120897.png)

- 输入进程：模拟脱机输入时的外围控制机
- 输出进程：模拟脱机输出时的外围控制机
- 输入缓冲区：在输入进程的控制下，暂存输入设备输入的数据，再转存到输入井中
- 输出缓冲区：在输出进程的控制下，暂存输出井输出的数据，再传送到输出设备中

### 2.设备的分配与回收
设备分配考虑的因素
- 设备的固有属性
- 设备分配算法
- 设备分配中的安全性

从进程运行的安全性上考虑，设备分配有两种方式
`安全分配方式`：为进程分配一个设备后就将进程阻塞，本次I/O完成后才将进程唤醒。
- 优点:破坏了“请求和保持”条件，不会死锁
- 缺点：对于一个进程来说，CPU和/0设备只能串行工作

`不安全分配方式`：进程发出I/0请求后，系统为其分配I/0设备，进程可继续执行，之后还可以发出新的I/0请求。只有某个I/O请求得不到满足时才将进程阻塞个进程可以同时使用名个设备
- 优点：进程的计算任务和/0任务可以并行处理，使进程迅速推进
- 缺点：有可能发生死锁（死锁避免、死锁的检测和解除

**设备分配的步骤**
- 根据进程请求的物理设备名查找SDT(物理设备名师进程请求分配设备时提供的参数)
- 根据SDT查找DCT，若设备忙碌则将进程PCB挂到设备等待队列中，不忙碌则将设备分配给进程
- 根据DCT查找COCT，若控制器忙碌则将PCB挂到控制器等待队列中，不忙碌则将控制器分配给进程
- 根据COCT查找CHCT，若通道忙碌则将进程PCB挂到通道等待队列中，不忙碌则将通道分配给进程

### 3.缓冲区管理
缓冲区的作用：
- 缓和CPU与I/O设备之间速度不匹配的问题
- 减少对CPU的中断次数，放宽中断时间
- 解决数据粒度不匹配的问题
- 提高CPU和I/O设备之间的并行性










 


