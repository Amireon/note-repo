# 第3章 系统总线
## 3.1 总线的基本概念
总线是一组能为多个部件分时共享的公共信息传送线路
- 总线： 连接多个部件的信息传输线，各个部件共享的传输介质
- 特点：同一时间，只能有一个部件向总线发送信息，当可以有多个设备从总线接收相同的信息

1. 以CPU为核心的双总线结构
	M 总线：连接 CPU 和主存
	I/O 总线：建立 ACPU 和个 I/O 设备之间交换信息的通道，各种 I/O 设备通过 I/O 接口挂到 I/O  总线上，便于增删设备
	缺点：当I/O设备与存储器交换信息时，占用CPU，降低工作效率

2. 单总线结构框图
	CPU、主存和 I/O 设备都挂在一组总线上
	需要设置总线判优逻辑

3. 以存储器为中心的双总线结构
	存储总线：在单主线基础上开辟出一条 CPU 与主存之间的总线


4. 三种总线结构比较分析
| 结构框图   | 优点                                  | 缺点                                                       |
| ---------- | ------------------------------------- | ---------------------------------------------------------- |
| 单总线结构 | 结构简单，成本低，易于接入新设备      | 带宽低，负载重；多个部件只能征用唯一的总线，不支持并发操作 |
| 双总线结构 | 将低速 I/O 设备从单总线上分离出来     | 需要增加通道等硬件设备                                     |
| 三总线结构 | 底稿了 I/O 设备的性能，提高系统吞吐量 | 系统工作效率较低

## 3.2 总线分类
### 1.按数据传输格式
1.串行总线
- 一次传输一位
- 优点：只需要一条传输线，成本低廉，广泛应用于长距离传输;应用于计算机内部时，可以节省布线空间。
- 缺点：在数据发送和接收的时候要进行拆卸和装配，要考虑串行并行转换的问题

2.并行总线
- 一次可传输多位
- 优点: 总线的逻辑时序比较简单电路实现起来比较容易
- 缺点: 信号线数量多，占用更多的布线空间；远距离传输成本高昂；由于工作频率较高时，并行的信号线之间会产生严重干扰对每条线等长的要求也越高，所以无法持续提升工作频率

3.串行总线与并行总线的传输速度分析
- 工作频率相同时，串行总线传输速度比并行总线慢
- 并行总线的工作频率无法持续提高而串行总线可以通过不断提高工作频率来提高传输速度，最终超过并行总线
- 在高速设备上使用串行总线


### 2.按总线功能
1.片内总线：芯片内部的总线

2.系统总线
计算机各部件之间的信息传输线
- 数据总线：指令和操作数等，双向，位数与机器字长、存储字长有关
- 地址总线：传输主存单元或I/O端口的地址等，单向，位数与存储地址、I/O地址有关
- 控制总线:  一根控制线传输一个信号，单向，但从整组来看有输出有输入

3.通信总线
- 用于计算机系统之间或计算机系统与其他系统之间的通信
- 按传输方式分为串行通信总线和并行通信总线


## 3.3 总线特性及性能指标
### 1.总线特性
1. 机械特性：尺寸、形状、管脚数、排列顺序
2. 电气特性：传输方向和有效的电平范围
3. 功能特性：每根传输线的功能：地址、数据、控制
4. 时间特性：信号的时序关系

### 2.总线性能指标
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011151812.png)

| 性能指标条目  | 含义                         |
| ------------- | ---------------------------- |
| 总线宽        | 数据线的根数                 |
| 标准传输率    | 每秒传输的最大字节数（MBps） |
| 时钟同步/异步 | 同步、不同步                 |
| 总线复用      | 地址线与数据线复用           |
| 信号线数      | 地址线、数据线和控制线的总和 |
| 总线控制方式  | 并发、自动、仲裁、逻辑、计数 |
| 其他          | 负载能力                 |

**总线带宽(标准传输率）**：`总线带宽 = 总线工作频率 * (总线宽度 / 8) B/s` 
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011138211.png)

- 总线带宽是总线能达到的最高传输速率
- 在计算实际的有效数据传输率时，要用实际传输的数据量除以耗时

> 例题：总线龚总频率为 22MHz，总线宽度为 16位，则 总线带宽 = 22*(16/8) = 44MB/S


![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011150908.png)

例题

![image-总线带宽例题](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011143291.png)

### 3.总线标准

总线标准是国际上公布或推荐的互连各个模块的标准，它是把各种不同的模块组成计算机系统时必须遵守的规范。按总线标准设计的接口可视为通用接口，在接口的两端，任何一方只需根据总线标准的要求完成自身方面的功能要求，而无须了解对方接口的要求。

- 系统总线标准：ISA、EISA、VESA、PCI、PCI-Express等。
- 设备总线标准：IDE、AGP、RS-232C、USB、SATA、SCSI、PCMCIA等·
- 局部总线标准：高速设备，在ISA总线和CPU总线之间增加的一级总线或管理层，如PCI、PCI-E、VESA、AGP等，可以节省系统的总带宽。

> 即插即用（Plug-and-Play）的作用是自动配置（低层）计算机中的板卡和其他设备，然后告诉对应的设备都做了什么。把物理设备和软件（设备驱动程序）相配合，并操作设备，在每个设备和它的驱云程序之间建立通信信道。
>
> 热插拔（hot-plugging或Hot Swap）即带电插拔，热插拔功能就是允许用户在不关闭系统，不切断电源的情况下取出和更换损坏的硬盘、电源或板卡等部件，从而提高了系统对灾难的及时恢复能力、扩展性和灵活性等，例如一些面向高端应用的磁盘镜像系统都可以提供磁盘的热插拔功能。

![image-20230201142222093](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011422427.png)

**ISA与EISA**

最早的PC总线是IBM公司1981年在PC/XT电脑采用的系统总线，它基于8bit的8088 处理器，被称为PC总线或者
PC/XT总线。

1984年，IBM推出基于16-bit Intel 80286处理器的PC/AT电脑，系统总线也相应地扩展为16bit，并被称呼为
PC/AT总线。而为了开发与IBM PC兼容的外围设备，行业内便逐渐确立了以IBM PC总线规范为基础的ISA（工业
标准架构：Industry Standard Architecture）总线

ISA总线最大传输速率仅为8MB/s，数据传送需要CPU或DMA接口来管理，传输速率过低、CPU占用率高、占用硬件中断资源等，很快使ISA总线在飞速发展的计算机技术中成为瓶颈。不支持总线仲裁。

因此在1988年，康柏、惠普等9个厂商协同把ISA 扩展到32-bit，这就是著名的EISA（Extended ISA，扩展ISA）总
线。EISA总线的工作频率仍旧仅有8MHz，并且与8/16bit的ISA总线完全兼容，带宽提高了一倍，达到了32MB/S
从CPU中分离出了总线控制权，支持多个总线主控器和突发传送。可惜的是，EISA仍旧由于速度有限，并且成本过高。被PCI总线取代了

**PCI**

由于ISA/EISA总线速度缓慢，造成硬盘、显示卡还有其它的外围设备只能通过慢速并且狭窄的瓶颈来发送和接受数据，使得整机的性能受到严重的影响。为了解决这个问题，1992年Intel在友布486处理器的时候，也向时提出了32-bit 的PCI(周边组件互连）总线

最早提出的PCl总线工作在33MHz频率之下，传输带宽达到」133MB/s（33MHz X 32bit/8），比ISA 总线有了极大的改善，基本上满足了当时处理器的发展需要。目前计算机上广泛采用的是这种32-bit、33MHz的PCI总线，可扩展到64bit

PCI特点：

- 高性能：不依附于某个具体的处理器，支持突发传送
- 良好的兼容性
- 支持即插即用。
- 支持多主设备。
- 具有与处理器和存储器于系统完全并行操作的能力
- 提供数据和地址奇偶校验的能力
- 可扩充性好，可采用多层结构提高驱动能力
- 采用多路复用技术，减少总线引脚个数

**AGP**

PCI总线足独立于CPU的局部总线，可将显示卡、声卡、网卡、硬盘控制器等局速的外围设备直接挂在CPU总线上，打破了瓶颈，使得CPU的性能得到充分的发挥。可惜的是，由于PCI总线只有133MB/s的带宽，对付声卡、网卡、视频卡等绝大多数输入/输出设备也许显得绰绰有余，但对于胃口越来越大的3D显卡却力不从心，并成为了制约显示子系统和整机性能的瓶颈。因此，PCI总线的补充一一AGP总线就应运而生了。

Intel于1996年7月正式推出了AGP(加速图形接口，Accelerated Graphics Port)接口，这是显示卡专用的局部总线，是基于PCI 2.1版规范并进行扩充修改而成，工作频率为66MHz，1X模式下带宽为266MB/S，是PCI总线的两倍。后米依次又推出」AGP 2X、AGP 4X，现在则是AGP 8X，传输速度达到了2.1GB/S

**PCI-E**

Intel在2001年春季的IDF上，正式公布了旨在取代PCI总线的第三代I/0技术，最后却被正式命名为PCI-Express
。Express意思是高速、特别快的意思。

PCI Express总线是一种完全不同于过去PCI总线的一种全新总线规范，与PCI总线共享并行架构相比，PCI Express
总线是一种点对点串行连接的设备连接方式，点对点意味着每一个PCI Express设备都拥有自己独立的数据连接，各个设备之间并发的数据传输互不影响，而对于过去PCI那种共享总线方式，PCI总线上只能有一个设备进行通信，一旦PCI总线上挂接的设备增多，每个设备的实际传输速率就会下降，性能得不到保证·

在传输速率方面，PCI Express总线利用串行的连接特点将能轻松将数据传输速度提到一个很高的频率，达到远超出PCI总线的传输速率。与此同时，PCI Express总线支持双向传输模式，还可以运行全双工模式

支持热拔插

**USB**

USB是在1994年底由英特尔等多家公司联合在1996年推出后，已成功替代串口和并口，已成为当今电脑与大量
智能设备的必配接口。USB属于设备总线，是设备和设备控制器之间的接口。

USB所有新版本都向下兼容，可以连接鼠标、键盘、打印机、扫描仪、摄像头、充电器、闪存盘、MP3机、手机
、数码相机、移动硬盘、外置光软驱、USB网卡、ADSL Modem、Cable Modem等几乎所有的外部设备。

- 可以热插拔、即插即用
- 具有很强的连接能力和很好的可扩充性。米用菊花链形式将众多外设连接起来，可使用USB集线器链式连接
  127个外设。
- 标准统一。以前大家常见的是IDE接口的硬盘，串口的鼠标键盘，并口的打印机扫描仪，可是有了USB之后
  这些应用外设统统可以用同样的标准与个人电脑连接，这时就有了USB硬盘、USB鼠标、USB打印机等等
- 高速传输·
- 连接电缆轻巧，可为低压(5V)外设供电

**RS-232C**

RS-232C是应用于串行二进制交换的数据终端设备（DTE）和数据通信设备（DCE）之间的标准接口。

RS-232C是美国电子工业协会EIA（Electronic Industry Association）联合贝尔系统、调制解调器厂家及计算机终端生产）家共同制定的一种串行物理接口标准。RS是英文“推荐标准”的缩写，232为标识号，C表示修改次数。RS-232C总线标准设有25条信号线，包括一个主通道和一个辅助通道。

该标准规定米用一个25个脚的DB-25连接器，对连接器的每个引脚的信号内容加以规定，还对各种信号的电平加以规定。后来IBM的PC机将RS232简化成了DB-9连接器，从而成为事实标准。而工业控制的RS-232口一般只使用RXD、TXD、GND三条线·

## 3.4 总线结构

### 1.单总线结构

- 结构：CPU、主存、I/O设备（通过I/O接口）都连接在一组总线上，允许IO设备之间、I/O设备和CPU之间或I/0设备与主存之间直接交换信息
- 优点：结构简单，成本低，易于接入新的设备
- 缺点：带宽低、负载重y多个部件只能争用唯一的总线，且不支持并发传送操作

![image-20230131215246033](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301312152116.png)

> 单总线并不是指只有一根信号线，系统总线按传送信息的不同可以细分为地址总线、数据总线和控制总线

### 2.双总线结构

- 结构：双总线结构有两条总线，一条是主存总线，用于CPU、主存和通道之间进行数据传送；另一条是I/O总线，用于多个外部设备与通道之间进行数据传送
- 优点：将较低速的I/O设备从单总线上分离出来，实现存储器总线和I/O总线分离。
- 缺点：需要增加通道等硬件设备 

![image-20230131215552735](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301312155825.png)

> 主存总线支持突发（猝发）传送：送出一个地址，收到多个地址连续的数据

> 通道是具有特殊功能的处理其，能对I/O设备进行统一管理，通道程序放在主存中

### 3.三总线结构  

思路：将速率不同的I/O设备进行分类，然后将它们连接在不同通道上

- 结构：三总线结构是在计算机系统各部件之间采用3条各自独立的总线来构成信息通路，这3条总线分别为主存总线、I/O总线和直接内存访问DMA总线
- 优点：提高了1/0设备的性能，使其更快地响应命令，提高系统吞吐量
- 缺点：系统工作效率较低，任意时刻只能使用一种总线，I/O总线只有CPU执行I/O指令时使用

![image-20230131220244212](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301312202306.png)

### 4.四总线结构

了解即可

![image-20230131221122160](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301312211274.png)

### 4.小结

![image-20230131221029537](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301312210714.png)

## 3.5 总线控制
总线上连接这多个部件，同一时刻只能有一个设备向总线发送数据，可以有多个设备从总线接收数据

如何控制这些部件：判优控制(仲裁逻辑)或通信控制

### 1.总线判优控制
总线上的各类设备按对总线有无控制权，分为
- 主设备(模块）：对总线有控制权
- 从设备(模块）：被主设备访问的设备，只能响应从主设备发来的总线命令

总线仲裁:名个主设备同时竞争主线控制权时，以某种方式选择一个主设备优先获得总线控制权称为总线仲裁

总线判优控制分为
- 集中式仲裁：将控制逻辑集中在一处，如CPU
- 分布式仲裁：将控制逻辑分散在于总线连接的各个设备上

#### 集中仲裁方式
**集中仲裁方式的工作流程**
1. 主设备发出请求信号
2. 若多个主设备同时要使用总线，则由总线控制器的判优、仲裁逻辑按一定的优先等级顺序确定哪个主设备能使用总线;
3. 获得总线使用权的主设备开始传送数据

常见的三种集中控制判优方式如下：

|    查询方式    |                          优点                          |                      缺点                      | 控制线数量 |
|:--------------:|:------------------------------------------------------:|:----------------------------------------------:|:----------:|
|    链式查询    | 只需少量控制线即可按优先次序实现总线控制；扩充设备简单 | 对电路故障敏感度高；优先级低的设备很难获得请求 |     2      |
| 计数器定时查询 |                   对电路故障敏感度低                   |                  增加了控制线                  | $log_{2 n}+2$  |
|    独立请求    |             响应速度快；优先级次序控制灵活             |          控制线数量过多，总线控制复杂          |     2n     |

**1.链式查询方式**
- 发请求BR，请求允许BG查询，总线使用BS
- 设备优先级固定：距离总线控制部件越近，优先级越高
- "总线忙”信号的建立者是获得总线控制权的设备
- 优点：只需少量控制线即可完成优先级总线控制；扩充设备简单
- 缺点：优先级低的设备很难获得总线使用权；对电路故障敏感；

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011209512.png)

**2.计数器查询方式**
- 结构特点：用一个计数器控制总线使用权，相对链式查询方式多了一组(不是一根，增加了电路的容错)设备地址线，少了一根总线响应线BG; 仍共用一根总线请求线BR。
- 优点: 计数初始值可以改变优先次序; 对电路的故障没有链式敏感
- 缺点：增加了控制线数，n个设备需$log_{2}n +2$ 条控制线；控制相对链式复杂

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011214427.png)

**3.独立请求方式**
- 结构特点：每个设备都有一根总线请求线BR和一根总线允许线BG；使用控制器
- 优点：响应速度快，优先级次序控制灵活；
- 缺点：控制线数量多；总线的控制逻辑复杂

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011300444.png)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011303605.png)

#### 分布仲裁方式
> 了解

特点：不需要中央仲裁器，每个潜在的主模块都有自己的仲裁器和仲裁号，多个仲裁器竞争使用总线
工作流程：
1. 当设备有总线请求时，它们就把各自唯一的仲裁号发送到共享的仲裁总线上
2. 每个仲裁器将从仲裁总线上得到的仲裁号与自己的仲裁号进行比较:
3. 如果仲裁总线上的号优先级高，则它的总线请求不予响应，并撤销它的仲裁号:
4. 获胜者的仲裁号保留在仲裁总线上

### 2.总线通信控制
**总线周期**：完成一次总线操作的时间，分为如下四个阶段：

- 申请分配阶段：主模块申请，总线仲裁决定
- 寻址阶段：主模块向从模块给出地址和命令，启动从模块
- 传输阶段：主模块和从模块交换数据
- 结束阶段：主模块从总线上撤销有关消息，让出总线使用权

**总线通信控制**：解决通信双方协调配合的问题，四种方式

- 同步通信：由统一时标控制数据传送，也称同步定时方式
- 异步通信：采用应答方式，没有公共时钟标准，也称异步定时方式
- 半同步通信：同步、异步结合
- 分离式通信：充分挖掘系统总线每个瞬间的潜力

#### 同步通信

同步定时方式是指系统采用一个统一的时钟信号来协调发送和接收双方的传送定时关系

时钟产生相等的时间间隔，每个间隔构成一个总线周期

在一个总线周期中，发送方和接收方可进行一次数据传送

因为采用统一的时钟，每个部件或设备发送或接收信息都在固定的总线传送周期中，一个总线的传送周期结束，下一个总线传送周期开始

**优点**：规定明确统一，模块间的配合简单一致；传送速度快，具有较高的传输速率；总线控制逻辑简单

**缺点**：主从设备属于强制性同步；不能及时进行数据通信的有效性检验，可靠性较差；按最慢的设备设计公共时钟

适用：总线长度较短、各部件存取时间比较一致的系统

影响总线数据传输率的两方面因素：

- 总线传输周期
- 数据线的位数

#### 异步通信

结构特点：

1. 在异步定时方式中，没有统一的时钟，也没有固定的时间间隔，完全依靠传送双方相互制约的“握于”信号来实现定时控制。
   主设备提出交换信息的“请求”信号，经接口传送到从设备；从设备接到主设备的请求后，通过接口向主设备发出“回答”信号。

2. 根据请求和回答信号的撤销是否互锁，分为: 不互锁方式，半互锁方式，全互锁方式

> 类似于TCP的三次握手的演进: TCP如何维持可靠通信

![image-20230201135248334](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011352517.png)

- **优点**：总线周期长度可变，能保证两个工作速度相差很大的部件或设备之间可靠地进行信息交换，自动适应时间的配合。
- **缺点**：比同步控制方式稍复杂一些，速度比同步定时方式慢
- 场景：并行传送、串行传送

**异步串行通信传送字符的格式**
![](https://raw.githubusercontent.com/Anlieh/PicBucket/master/20220921195351.png)

**异步通信-数据传输率的衡量**

- 波特率：单位时间传送二进制数据的位数，单位 bps，记作波特
- 比特率：单位时间传送二进制有效数据的位数，单位 bps，

![image-20230201140205196](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011402351.png)

#### 半同步通信

同步：发送方用系统时钟前沿发信号；接收方用系统时钟后沿判断、识别

异步：允许不同速率的模块和谐工作

半同步通信：统一时钟的基础上，增加一个等待响应信号WAIT'

![image-20230201140504705](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011405784.png)
- 半同步通信既保留了同步通信的所有特点，如所有的地址、命令、数据信号的发出时间，都严格参照系统时钟的某个前沿开始，而接受方都采用系统时钟后沿时刻来进行判断识别；
- 同时又像异步通信那样，允许不用速度的模块和谐地工作。

 #### 分离式通信
同步通信、异步通信、半同步通信的共同点

一个总线传输周期，以输入数据为例：

-  主模块发地址、命令 : 占用总线
-  从模块准备数据:  不占用总线
-  从模块向主模块发送数据: 占用总线

**分离式通信的一个总线周期**

子周期1: 主模块申请占用总线，使用完后放弃总线的使用权
子周期2:从模块申请占用总线，将各种信息送至总线上

**分离式通信的特点**

- 各模块有权申请占用总线
- 采用同步通信方式，不等对方回答
- 各模块准备数据时，不占用总线
- 总线利用率高



![image-20230201141423878](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011414009.png)

## 本章考研大纲

![image-20230201140353827](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011403930.png)