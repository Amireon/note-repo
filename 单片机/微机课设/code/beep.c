/**进行音乐播放的例程,按下key1键后开始播放音乐
基于STC15F2K60S2系列单片机C语言编程实现
使用如下头文件，不用另外再包含"REG51.H"
*/
#include <stc8h.h>
#include "beep.h"
#include "delay.h"

#define uint unsigned int
#define uchar unsigned char
	
sbit beep = P1^1;			  //蜂鸣器
sbit key1 = P3^2;			//按键1
sbit key2 = P3^3;			//按键2
uchar timeh,timel,jindu=0,gequ=0;		  //定义定时器的重装值
bit play_flag;	//播放标志位

//国际歌，格式为: 音符, 节拍, 音符, 节拍,
uchar code music1[] =     
{
    0x25, 0x10, 0x31, 0x18, 0x27, 0x08, 0x32, 0x08, 0x31, 0x08, 0x25, 0x08, 0x23, 0x08, 0x26, 0x18, 0x26, 0x08, 0x24, 0x10, 0x20, 0x08,
    0x26, 0x08, 0x32, 0x18, 0x31, 0x08, 0x27, 0x08, 0x26, 0x08, 0x25, 0x08, 0x24, 0x08, 0x23, 0x30,
    0x25, 0x10, 0x31, 0x18, 0x27, 0x08, 0x32, 0x08, 0x31, 0x08, 0x25, 0x08, 0x23, 0x08, 0x26, 0x20, 0x24, 0x08,
    0x26, 0x08, 0x32, 0x08, 0x31, 0x08, 0x27, 0x10, 0x32, 0x10, 0x34, 0x10, 0x27, 0x10, 0x31, 0x20, 0x31, 0x08, 0x30, 0x08,
    0x33, 0x08, 0x32, 0x08, 0x27, 0x20, 0x26, 0x08, 0x27, 0x08, 0x31, 0x08, 0x26, 0x08, 0x27, 0x20, 0x25, 0x08,
    0x25, 0x08, 0x24, 0x08, 0x25, 0x08, 0x26, 0x18, 0x26, 0x08, 0x32, 0x18, 0x31, 0x08, 0x27, 0x20, 0x27, 0x08, 0x20, 0x08,
    0x32, 0x10, 0x32, 0x18, 0x27, 0x08, 0x25, 0x08, 0x25, 0x08, 0x24, 0x08, 0x25, 0x08, 0x33, 0x20, 0x31, 0x08,
    0x26, 0x08, 0x27, 0x08, 0x31, 0x08, 0x27, 0x10, 0x32, 0x10, 0x31, 0x10, 0x26, 0x10, 0x25, 0x20, 0x25, 0x08, 0x20, 0x08,
    0x33, 0x08, 0x32, 0x08, 0x31, 0x20, 0x25, 0x18, 0x23, 0x08, 0x26, 0x20, 0x24, 0x08, 0x20, 0x08,
    0x32, 0x0c, 0x31, 0x04, 0x27, 0x20, 0x26, 0x10, 0x25, 0x10, 0x25, 0x20, 0x25, 0x08, 0x20, 0x08,
    0x25, 0x10, 0x33, 0x20, 0x32, 0x10, 0x25, 0x10, 0x31, 0x20, 0x27, 0x18,
    0x27, 0x08, 0x26, 0x18, 0x25, 0x08, 0x26, 0x10, 0x32, 0x10, 0x32, 0x20, 0x32, 0x08, 0x30, 0x08,
    0x33, 0x0c, 0x32, 0x04, 0x31, 0x20, 0x25, 0x18, 0x23, 0x08, 0x26, 0x20, 0x24, 0x08, 0x20, 0x08,
    0x32, 0x0c, 0x31, 0x04, 0x27, 0x20, 0x26, 0x10, 0x25, 0x10, 0x33, 0x30,
    0x33, 0x10, 0x35, 0x20, 0x34, 0x10, 0x33, 0x10, 0x32, 0x18, 0x33, 0x08, 0x34, 0x10, 0x30, 0x08,
    0x34, 0x08, 0x33, 0x18, 0x33, 0x08, 0x32, 0x18, 0x32, 0x08, 0x31, 0x30,
    0x00, 0x00
};

// 各个音符在定时器中的重装值，第一列是高位，第二列是低位	
uchar code quzi[] =  	
{
    0xf8,0x8c,	  //低八度，低1
    0xf9,0x5b,
    0xfa,0x15,	  //低3
    0xfa,0x67,
    0xfb,0x04,	  //低5
    0xfb,0x90,
    0xfc,0x0c,	  //低7
    0xfc,0x44,	  //中央C调
    0xfc,0xac,	  //中2
    0xfd,0x09,
    0xfd,0x34,	  //中4
    0xfd,0x82,
    0xfd,0xc8,	  //中6
    0xfe,0x06,
    0xfe,0x22,	  //高八度，高1
    0xfe,0x56,
    0xfe,0x6e,	  //高3
    0xfe,0x9a,
    0xfe,0xc1,	  //高5
    0xfe,0xe4,
    0xff,0x03	  //高7
};


/**
 * 在quzi数组中，找到music数组定义的简谱音符的重装值，并返回其在quzi数组中的位置
 * 入口参数：tem：music数组中定义的简谱音符
 * 出口参数：返回的是tem音符在quzi数组中的位置值
*/
uchar quyin(uchar tem)
{
    uchar qudiao,jp,weizhi;		  //定义曲调，音符和位置
    qudiao=tem/16;				  //高4位是曲调值
    jp=tem%16;					  //低4位是音符
    if(qudiao==1)				  //当曲调值为1时，即是低八度，低八度在quzi数组中基址为0
        qudiao=0;
    else if(qudiao==2)			  //当曲调值为2时，即是中八度，中八度在quzi数组中基址为14
        qudiao=14;
    else if(qudiao==3)			  //当曲调值为3时，即是高八度，高八度在quzi数组中，基址为28
        qudiao=28;
    weizhi=qudiao+(jp-1)*2;		  //通过基址加上音符作为偏移量，即可定位此音符在quzi数组中的位置
    return weizhi;				  //返回这一个位置值
}


/** 播放音乐 */
void Beep_Play()
{
    uchar p,m,tem;   //m为节拍
    while(1)
    {
        if(play_flag==1)					  //若播放的标志位为1则播放音乐
        {
			p=music1[jindu];
            if(p==0x00)			  //如果碰到结束符,延时1秒,回到开始再来一遍
            {
                jindu=0;
                Delay(1000);
                    // break;
            }
            else if(p==0xff) 	  //若碰到休止符,延时100ms,继续取下一音符
            {
                    jindu=jindu++;
                    Delay(100);
                    TR0=0;
                    // break;
            }
            else				   //正常情况下取音符和节拍
            {
                    tem=quyin(music1[jindu]);		//取出当前音符在quzi数组中的位置值
                    timeh=quzi[tem];				//把音符相应的计时器重装载值赋予timeh和timel
                    timel=quzi[tem+1];
                    jindu++;
                    TH0=timeh;						//把timeh和timel赋予计时器
                    TL0=timel;
                    m=music1[jindu];					 //取得节拍
                    jindu++;
            }
                TR0=1;                            //开定时器1
                Delay(m*180);    				  //等待节拍完成, 通过蜂鸣器输出音频
                TR0=0;                            //关定时器1
                beep=1;				
        }
    }
}


/** 定时器和外部中断的初始化 */
void Beep_Init()
{
	P0M0 = 0xff;			  //设置推挽模式
	
    TMOD = 0x01;		//设置定时器0，定时方式1，16位手动重装模式
    TH0 = 0xD8;			  //设置定时初值
    TL0 = 0xEF;
    IE = 0x87;			  // 1000 0111  EA=1,EX0=1,ET0=1,EX1=0;
    IP = 0x02;			  // 0000 0010  PT0=1;   定时器0优先级高
    TR0 = 0;				  //定时器0开始运行
    beep = 1;				  
}


void Beep_Set(unsigned int flag)
{
	play_flag = flag;
}	


/** 定时器0中断处理，重新装值，并把beep值取反，产生方波 */
void Timer0() interrupt 1						//计时器控制频率
{
    TH0=timeh;								//赋初值
    TL0=timel;
    beep=~beep;							   //中断使得beep翻转产生方波
}
