
## 2.4 EMail
### 组成部分
三个主要组成部分：用户代理、邮件服务器、简单邮件传输协议
**用户代理**：又称邮件阅读器，撰写、编辑和阅读邮件，输出和输入邮件保存在服务器上
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261328897.png)

**邮件服务器**
- 邮箱中管理和维护发送给用户的邮件
- 输出报文队列保持待发送邮件报文
- 邮件服务器之间的SMTP，发送email报文
	- 客户：发送方邮件服务器
	- 服务器：接收端邮件服务器

**简单邮件传输协议，SMTP**
- 使用TCP在客户端负服务器之间传送报文，端口号为25
- 直接传输：从发送方服务器到接收方服务器
- 传输的3个阶段：握手、传输报文、关闭
- 命令/响应交互
	- 命令：ASCTT文本
	- 响应：状态码和状态信息
- 报文必须为7位ASCTT码

**举例：Alice给Bob发送报文**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261343789.png)
### SMTP
简单的SMTP交互
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261344641.png)

**SMTP总结**
- SMTP使用持久连接
- SMTP要求报文（首部和主体）为7为ASCII编码
- SMTP服务器使用CRLF决定报文的尾部

与HTTP比较：
- HTTP：拉pull
- SMTP：推push
- 二者都是ASCII形式的命令、响应交互、状态码
- HTTP：每个对象封装在各自的响应报文中
- SMTP：多个对象包含在一个报文中

### 邮件报文格式
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261358726.png)

多媒体扩展
MIME：多媒体邮件扩展（multimedia mail extension），在报文首部使用额外的行声明MIME内容
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261353326.png)


### 邮件访问协议
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261354953.png)

SMTP：传送到接收方的邮件服务器
邮件访问协议：从服务器访问邮件
- POP：邮件访问协议（Post Office Protocol），用户身份确认（代理、服务器）并下载
- IMAP：Internet邮件访问协议（Internet Mail Access Protocol），在服务器上处理存储的报文
- HTTP：Hotmail、Yahool Mail等

**POP3协议**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212261357613.png)
**POP3与IMAP**
| POP3                                                            | IMAP                                                               |
| --------------------------------------------------------------- | ------------------------------------------------------------------ |
| 先前的例子使用“下载并删除”模式，如果改变客户机，Bob不能阅读邮件 | IMAP服务器将每个报文与一个文件夹联系起来，允许用户用目录来组织报文 |
| 下载并保留：不用客户机上为报文的拷贝                            | 允许用户读取报文组件                                               |
| POP3在会话中是无状态的                                          | IMAP在会话中保留用户状态：目录名、报文ID与目录名之间映射           |
| 本地管理文件夹                                                  | 远程管理文件夹                                                                   |

## 2.5 DNS



## 2.6 P2P应用
**纯P2P架构的特点**
- 极少有一直运行的服务器
- 任意端系统都可以直接通信
- 利用peer的服务能力
- peer节点间歇上网，每次IP地址都有可能变化

### 文件分发时间
**问题：** 从一台服务器分发文件（大小F）到N个peer需要多少时间？
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271101602.png)

**1.文件分发时间：C/S模式**
服务器传输：有服务器发送给peer，服务器必须顺序传输（上载）N个文件拷贝，NF/us
客户端：每个客户端下载一个文件拷贝，
- dmin = 客户端最小下载速率，
- 下载带宽最小的客户端的下载时间：F/dmin

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271105693.png)

**2.文件分发时间：P2P模式**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271106157.png)
**3.Client-server与P2P的速率比较**
C/S模式的下载速率受客户端数量的影响很大
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271106909.png)
### P2P文件分发：BitTorrent
**BitTorrent的特点**
- 文件被分成大小为256KB的块
- 网络中这些peers发送接收文件块，互相服务
- 当peer下载时，该peer可以同时向其他节点提供上载服务
- Peer可能会变换用于交换块的peer节点
- 扰动churn： peer节点可能会上线或者下线
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271109733.png)
**Peer加入Torrent的过程**
- 一开始没有块，但是将会通过其他节点处累积文件块
- 向跟踪服务器注册，获得peer节点列表，和部分peer节点构成邻居关系（“连接“）

**BitTorrent：请求，发送文件块**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271115186.png)
**P2P文件共享**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271116716.png)

### P2P：集中式目录
**存在的问题**
文件传输是分散的，而定位内容是高度集中的
- 单点故障
- 性能瓶颈
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271137787.png)
### Gnutella协议
- 全分布式：没有中心服务器
- 开放文件共享协议
- 许多Gnutella客户端实现了Gnutella协议

覆盖网络：图
- 如果X与Y之间有TCP连接，则二者之间存在一条边
- 所有活动的对等方和边就是覆盖网络
- 边是逻辑链路，不是物理链路
- 一个peer连接的节点通常少与10个
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271142904.png)
**Gnutella对等方加入**
1. 对等方X必须首先发现某些已经在覆盖网络中的其他邓等方：使用可用对等方列表。自己维持一张对等方列表（经常开机的对等方的IP），联系维持列表的Gnufella站点
2. X接着试图与该列表上的对等方建立TCP连接，直到与某个对等方Y建立连接
3. X向Y发送一个Ping报文，Y转发该Ping报文
4. 所有收到Ping报文的对等方以Pong报文响应：IP地址、共享文件的数量及总字节数
5. X收到许多Pong报文，然后它能建立其他TCP连接

### KaZaA协议
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212271144523.png)

**KaZaA：查询**
- 每个文件有一个散列标识码和一个描述符
- 客户端向其组长发送关键字查询
- 组长用匹配进行响应：元数据、散列标识码和IP地址
- 如果组长将查询转发给其他组长，其他组长也进行响应
- 客户端选择要下载的文件：向拥有文件的peer发送一个带散列标识码的HTTP请求

**KaZaA小技巧**
- 请求排队：限制并行上载的数量；确保每个被传输的文件从上载节点接收一定量的带宽
- 激励优先权：鼓励用户上载文件；加强系统的扩展性
- 并行下载：从多个peer下载同一文件的不同部分，HTTP的字节范围首部

Distributed Hash Table（DHT）
- 哈希表
- DHT方案
- 环形DHT以及覆盖网络
- Peer波动

