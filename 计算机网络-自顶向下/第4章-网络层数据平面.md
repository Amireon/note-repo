**本章目标**
- 理解网络服务的基本原理，聚焦于其数据平面
	- 网络服务模型
	- 转发和路由
	- 路由器工作原理
	- 通用转发
- 互联网中网络层协议的实例和实现

## 4.1 导论
**1.网络层服务**
- 在发送主机和接收主机对之间传送段(segment)
- 在发送端将段封装到数据报中
- 在接收端，将段上交给传输层实体
- 网络层协议存在于每一个主机和路由器
- 路由器检查每一个经过它的IP数据报的头部

**2.网络层功能**
- 转发:将分组从路由器的输入接口转发到合适的输出接口
- 路由：使用路由算法来决定分组从发送主机到目标接收主机的路径
	- 路由选择算法
	- 路由选择协议

**3.数据平面与控制平面**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301091947237.png)

传统方式：每-路由器(Per-router)控制平面
在每一个路由器中的单独路由器算法元件，在控制平面进行交互
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301091949664.png)

传统方式：路由和转发的相互作用
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301091950328.png)

SDN方式：逻辑集中的控制平面
一个不同的（通常是远程的）控制器与本地控制代理（CAs）交互
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301091951165.png)

**网络服务模型**
Q：从发送方主机到接收方主机传输数据报的”通道“，网络提供什么样的服务模型？

对于单个数据报的服务：
- 可靠传送
- 延迟保证

对于数据报流的服务：
- 保序数据报传送
- 保证流的最小带宽
- 分组之间的延迟差

**连接建立**
- 在分组传输前，在两个主机之间，在通过一些路由器所构成的路径上建立一个网络层连接、
- 网络层与传输层连接服务的区别：
	- 网络层：在2个主机之间，涉及到路径上的一些路由器
	- 传输层：在2个进程之间，很可能只体现在端系统上（TCP连接）

**网络层服务模型**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092031582.png)

## 4.2 路由器组成
### 1.路由器结构概况
高层面通用路由器体系架构
- 路由：运行路由选择算法/协议(RIP,OSPF,BGP)-生成路由表
- 转发：从输入到输出链路交换数据报-根据路由表进行分组的转发

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092033920.png)

**1.输入端口功能**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092034456.png)

**2.基于目标的转发**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092035086.png)

**3.最长前缀匹配**
longest prefix matching：当给定目标地址查找转发表时，采用最长地址前缀匹配的目标地址表项
- 在路由器中经常采用TCAMS(ternary content addressable memories)硬件来完成
- 内容可寻址性：将地址交给TCAM，可以在一个时钟周期内检索出地址，不断表内空间有多大
- Cisco Catalyst系列路由器：在TCAM中可以存储约为1百万条路由表项 

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092036808.png)

**4.输入端口缓存**
当交换结构的速率小于输出端口的汇聚速率时，在输入端口可能要排队
Head-of-the-Line(HOL) blocking：排在对头的数据报，阻止了队列中其他数据报向前移动
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092040795.png)

### 交换结构
- 将分组从输入缓冲区传输到合适的输出端口
- 交换速率：分组可以按照该速率从输入传输到输出
	- 运行速度经常是输入/输出链路速率的若干倍
	- N个输入端口：交换机构的交换速度是输入线路速度的N倍比较理想

3种典型的交换机构
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092042835.png)

**6.通过内存交换**
第一代路由器:
- 在CPU直接控制下的交换，米用传统的计算机
- 分组被拷贝到系统内存，CPU从分组的头部提取出目标地址，查找转发表，找到对应的输出端口，拷贝到输出端口
- 转发速率被内存的带宽限制（数据报通过BUS两遍
- 一次只能转发一个分组
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092043782.png)

**7.通过总线交换**
- 数据报通过共享总线，从输入端转发到输出端口
- 总线竞争：交换速度受限于总线带宽
- 1次处理一个分组
- 1 Gbps bus, Cisco 1900； 32Gbps buS,Cisco 5600；对于接入或企业级路由器，速度足够（但不适合区域或骨干网络）

**5.通过互联网络交换**
- 同时并发转发多个分组，克服总线带宽限制
- Banyan（榕树）网络，crossbar(纵横)和其它的互联网络被开发，将多个处理器连接成多处理器
- 当分组从端口A到达，转给端口Y：控制器短接相应的两个总线
- 高级设计：将数据报分片为固定长度的信元，通过交换网络交换
- Cisco12000：以60Gbps的交换速率通过互联网络
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092045662.png)

### 输出端口
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092046850.png)

**输出端口排队**
- 假设交换速率$R_switch$是$R_line$的N倍（N：输入端口的数量)
- 当多个输入端口同时向输出端口发送时，缓冲该分组（当通过交换网络到达的速率超过输出速率则缓存）
- 排队带来延迟，由于输出端口缓存溢出则去弃数据报

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092047852.png)

**Q：需要多少缓存？**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092049273.png)


### 调度机制
调度：选择下一个要通过链路传输的分组
- FIFO(first in first out) scheduling:按照分组到来的先后次序发送
- 丢弃策略：如果分组到达一个满的队列，哪个分组将会被抛弃?
	- tail drop: 丢弃刚到达的分组
	- priority: 根据优先权丢失/移除分组
	- random: 随机地丢弃/移除

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092052277.png)

**1.调度策略：优先权**
优先权调度：发送最高优先权的分组

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092053319.png)

**2.调度策略：Round Robin**
Round Robin(RR) scheduling ：多类
循环扫描不同类型的队列，发送完一类的一个分组，再发送下一个类的一个分组，循环所有类

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092055502.png)

**3.调度策略：WFQ**
Weighted Fair Queuing(WFQ):
- 一般化的Round Robin
- 在一段时间内，每个队列得到的服务时间是：Wi/(XIGMA(Wi)) * t，和权重成正比
- 每个类在每一个循环中获得不同权重的服务量

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092057092.png)

## 4.3 IP
> 互联网的网络层
> 主机，路由器中的网络层功能
> ![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092131912.png)

**IP数据报格式**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301092132881.png)


## 4.4 通用转发和SDN


