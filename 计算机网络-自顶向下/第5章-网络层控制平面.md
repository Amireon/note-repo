
**本章目标：理解网络层控制平面的工作原理**
- 传统路由选择算法
- SDN控制器
- ICMP：Internet Control Message Protocol
- 网络管理
- 在互联网上的实例和实现：OSPF，BGP，OpenFlow，ODL和ONOS控制器

**网络层功能**
- 转发：将分组从路由器的一个输入输出端口移到合适的输出端口，数据平面
- 路由：确定分组从源到目标的路径，控制平面

2种构建网络层控制平面功能的方法：
- 每个路由器控制功能实现（传统）
- 逻辑上集中的控制功能实现SDN

# 5.1 路由选择算法
## 路由的概念
路由route：按照某种指标（传输延迟，经过的站点数目等）找到一条从源节点到目标节点的较好路径
- 较好路径：按照某种指标较小的路径
- 指标：战数，延迟，费用，队列长度等，反映了网络使用者希望网络在什么方面表现突出

以网络为单位进行路由，路由信息通告+路由计算
- 网络以单位进行路由，路由信息传输，计算和匹配的代价低
- 前提条件是：一个网络所有节点地址前缀相同，且物理上聚集

网络到网络的路由=路由器-路由器之间路由
- 网络对应的路由器到其他网络对应的路由器的路由
- 在一个网络中，路由器-主机之间的通信，链路层解决

### 网络的图
网络的图抽象
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301021948054.png)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301022040140.png)

**最优化原则(optimality principle)**：汇集树（sink tree），此节点到所有其他节点的最优路径形成的树，路由选择算法就是为所有路由器找到并使用汇集树

### 路由选择算法的原则
- 正确性(correctness)：算法必须是**正确的和完整**的，使分组一站一站接力，正确发向目标站；完整：目标所有的站地址，在路由表中都能找到相应的表项；没有处理不了的目标站地址:
- 简单性(simplicify)：算法在计算机上应简单：最优但复杂的算法，时间上延迟很大，不实用，不应为了获取路由信息增加很多的通信量:
- 建壮性(robustness)：算法应能适应通信量和网络拓扑的变化：通信量变化，网络拓扑的变化算法能很快适应；不向很拥挤的链路发数据，不向断了的链路发送数据:
- 稳定性(stability)：产生的路由不应该摇摆
- 公平性(fairness)：对每一个站点都公平
- 最优性(opfimality)：某一个指标的最优，时间上，费用上，等指标，或综合指标；实际上，获取最优的结果代价较高，可以是次优的

## 路由算法分类
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301031613297.png)

###  link state算法
**配置LS路由选择算法的路由工作过程**
- 各点通过各种渠道获得整个网络拓扑，网络中所有链路代际等信息，属于协议和实现部分
- 使用LS路由算法，计算本站点到其他站点的最优路径，得到路由表
- 按照路由表转发分组（datagram方式）：严格意义上不属于路由过程，分发到输入端口的网络层
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301031618780.png)

**LS路由的基本工作过程**
1. 发现相邻节点，获知对方网络地址
2. 测量到相邻节点的代价，如延迟，开销
3. 组装一个LS分组，描述它到相邻节点的代价情况
4. 将分组通过扩散的方法发到所有其他路由器，让每个路由器获得拓扑和边代价
5. 通过Dijkstra算法找出最短路径：每个节点独立计算到其他节点的最短路径；迭代，第k步知道本节点到k个其他其他节点的最短路径

**LS路由选择算法的工作原理**
- 节点标记：每一个节点使用(D(v),P(v))标记，D(v)表示从源节点由已知最优路径到达本节点的距离；P(v)标记前序节点
- 临时节点(tentative node)：未找到从源节点到此节点的最优路径的节点
- 永久节点(permanent node)：临时节点的对立

**Dijkstra算法的例子**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301031627278.png)

### distance vector算法
距离矢量路由选择（distance vector routing），动态路由算法之一
基本思想：
- 各路由器维护一张路由表
- 各路由器与相邻路由器交互路由表
- 根据获得的路由信息，更新路由表

路由信息的更新
- 得到本节点A到相邻节点的代价
- 根据各相邻站点声称他们到目标站点B的代价
- 计算出本站点A经过各相邻站点到目标站点B的代价
- 计算最小的代价，和相应的下一个节点Z，到达节点B经过此节点Z，并且代价为A-Z-B的代价

距离矢量算法
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301031640418.png)


### LS与DV算法的比较
| 比较项目   | LS                                                                       | DV                                                                                 | 优势方 |
| ---------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------- | ------ |
| 消息复杂度 | n个节点，E条链路，发送报文O(nE)个，局部的路由信息，全局传播              | 只与邻居交换信息，全局的路由信息，局部传播                                         | DV     |
| 收敛时间   | O($n^{2}$)算法，可能震荡                                                 | 收敛较慢，可能存在路由环路，count-to-infinity问题                                  | LS     |
| 健壮性     | 节点会通告不正确的链路代价；每个节点只计算自己的路由表；错误信息影响较小 | DV节点可能通告对全国所有节点的不正确路径代价；每一个节点的路由表可能被其他节点使用 | LS       |

# 5.3 因特网中自治系统内部的路由选择
## RIP
RIP(Routing Information Protocol)，Distance vector算法
- 距离矢量：每条链路cost=1，
- DV每隔30秒和邻居交换DV，通告
- 每个通告包括：最多25个目标子网

