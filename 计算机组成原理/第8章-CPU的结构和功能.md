本章从分析CPU的功能和内部结构入手，详细套路机器完成一条指令的全过程，为了提高数据的处理能力、开发系统的并行性所采取的流水技术，还概括了中断技术在提高整机系统效能方面的作用。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041743922.png)

# 8.1 CPU的结构
## 1.CPU的功能
指令控制、操作控制、时间控制、数据加工、处理中断

1.控制器的功能
- 取指令
- 分析指令
- 执行指令
- 控制程序输入及结果的输出
- 总线管理
- 处理异常情况和特殊请求
- 总线管理
- 处理异常情况和特殊请求

2.运算器的功能
实现算术运算和逻辑运算

## 2.CPU结构框图 
1. CPU与系统总线
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041525616.png)

2. CPU的内部结构
![CPU的内部结构](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041523855.png)

## 3.CPU中的寄存器
1. 用户可见寄存器
| 类型         | 存放数据类型                         | 用途                                 |
| ------------ | ------------------------------------ | ------------------------------------ |
| 通用寄存器   | 存放操作数                           | 可作某种寻址方式所需的专用寄存器     |
| 数据寄存器   | 存放操作数（满足各种数据类型）       | 两个寄存器拼接存放双倍字长数据       |
| 地址寄存器   | 存放地址（其位数应满足最大地址范围） | 用于特殊的寻址方式，如段基址、栈指针 |
| 条件码寄存器 | 存放条件码                           | 可作程序分支的依据，如正、零、溢出等 |

2. 控制和状态寄存器
| 控制寄存器 | 作用                                                                   |
| ---- | ---------------------------------------------------------------------- |
| PC   | 程序计数器，存放现行指令的地址                                         |
| MAR  | 存储器地址寄存器，用于存放将被访问的存储单元的地址                     |
| MDR  | 存储器数据寄存器，用于存放欲存入存储器的数据或最近从存储器中读出的数据 |
| IR   | 指令寄存器，存放当前欲执行的指令                                                                       |
其中，MAR、MDR、IR用户不可见，PC用户可见
| 状态寄存器 | 作用       |
| ---------- | ---------- |
| 状态寄存器 | 存放条件码 |
| PSW寄存器  | 存放程序状态字           |

3. 控制单元CU和中断系统
CU 产生全部指令的微操作命令序列，俩种方式：
- 组合逻辑设计，硬连线逻辑
- 微程序设计，存储逻辑

中断系统主要用于处理计算机的各种中断

# 8.2 指令周期
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041838071.png)

## 1.指令周期的基本概念
- 指令周期的基本概念：从CPU中取出并执行一条指令所需的全部时间
- 指令周期常用机器周期（即CPU周期）表示
- 一个时钟周期包含若干时钟周期（CPU操作的基本单位）


**2.不同指令的指令周期**
每个指令周期内机器周期数可以不等，每个机器周期内的节拍数也可以不等
完成一条指令：取值周期（取值、分析），执行周期（执行）

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041752862.png)

CPU的工作周期：
- 取值周期：取指令
- 间址周期：取有效地址
- 执行周期：去操作数（当指令为访存指令时）
- 中断周期：保存程序断点

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041757025.png)

## 2.指令周期的数据流
假设CPU中有MAR、MDR、PC和IR

### 1.取值周期的数据流
1. 当前指令地址送至存储器地址寄存器，记做：（PC)→MAR
2. CU发出控制信号，经控制总线传到主存，这里是读信号，记做：1→R
3. 将MAR所指主存中的内容经数据总线送入MDR，记做：M(MAR）→MDR
4. 将MDR中的内容(此时是指令)送入IR，记做：（MDR)→IR
5. CU发出控制信号，形成下一条指令地址，记做：（PC)+1→PC

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041823035.png)

### 2.间址周期的数据流
1. 将指令的地九码送入MAR，记做：Ad(IR）→ MAR或Ad(MDR)→ MAR
2. CU发出控制信号，启动主存做读操作，记做：1→R
3. 将MAR所指主存中的内容经数据总线送入MDR，记做：M(MAR）→MDR
(不一定)4. 将有效地圳送至指令的地址码字段，记做:MDR→Ad(IR)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041822170.png)

### 3.执行周期的数据流
执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果。
不同指令的执行周期操作不同，因此没有统一的数据流向。

### 4.中断周期的数据流
**中断**：暂停当前任务去完成其他任务，为了能够恢复当前任务，需要保存断点。
一般使用堆栈来保存断点，这里用SP表示栈顶地址，假设SP指向栈顶元素，进栈操作是先修改指针，后存入数据

1. CU控制将SP减1，修改后的地址送入MAR，记做：（SP)-1 → SP，（SP)→ MAR
     本质上是将断点存入某个存储单元，设其地址为a，故可记做：a→MAR
2. CU发出控制信号，启动主存做写操作，记做：1→ W
3. 将断点(PC内容)送入MDR，记做：（PC)→ MDR
4. CU控制将中断服务程序的入口地址（由向量地址形成部件产生）送入PC，记做：向量地址→PC

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041831333.png)

## 3.指令执行方案
一个指令周期通常包括几个时间段（执行步骤），每个步骤完成指令的一部分功能，几个依次执行的步骤完成这条指令的全部功能。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211041837358.png)

**方案1 单指令周期**
对所有指令都选用相同的执行时间来完成。
指令之间串行执行：指令周期取决于执行时间最长的指令的执行时间。
对本来可以在更短时间内完成的指令，要使用这个较长的周期来完成，会降低整个系统的运行速度。

**方案2 多指令周期**
对不同类型的指令选用不同的执行步骤来完成，指令之间串行执行
可选用不同个数的时钟周期来完成不同指令的执行过程

**方案3 流水线方案**
在每一个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤中。
指令之间并行执行

# 8.3 指令流水
指令流水的产生原因：提高处理机速度，通常可以从提高机器的性能和改进系统的结构，开发系统的并行性两方面入手

并行：同时性+并发性，同时性指两个或多个事件在同一时刻发生，并发性指两个或多个事件在同一时间段发生。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172115363.png)


### 1.指令流水原理
2. 顺序执行方式
总耗时`T=n*3t=3nt`
传统冯诺依曼机采用顺序执行方式，又称串行执行方式，
- 优点：控制简单，硬件代价小
- 缺点：执行指令的速度较慢，任何时刻处理中只有一条执行在执行，各功能部件的利用率低
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211171951900.png)

2. 一次重叠执行方式
总耗时`T= 3t+ (n-1)×2t =(1+2n)t`
- 优点：程序的执行时间缩短了1/3，各功能部件的利用率明显提高
- 缺点：需要付出硬件上较大开销的代价，控制过程也比顺序执行复杂了。
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211171951610.png)

3. 二次重叠执行方式
总耗时T= 3t+ (n-1)×t = (2+n)t
与顺序执行方式相比，指令的执行时间缩短近2/3。这是一种理想的指令执行方式，在正常情况下处理
机中同时有3条指令在执行
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211171952820.png)

### 2.流水线的表示方法
1. 指令执行过程图
主要用于分析指令执行过程以及影响流水线的因素

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211171957155.png)

2. 时空图
空间：不同的阶段所对应的不同的硬件资源
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211171958858.png)

### 3.影响流水线性能的因素
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172053020.png)

为方便期间，假设流水线由5段组成：取指令（IF）、指令译码（ID）、有效地址计算（EX）、存取器访问（MEM）和结果写回寄存器（WB）

流水线每一个功能段部件后面都要有一个缓冲寄存器，或称为锁存器其作用是保存本流水段的执行结果，提供给下一流水段使用

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172030264.png)

#### 1.结构相关
资源冲突：由于多条指令在用一时刻争用同一资源而形成的冲突成为结构相关。
解决办法:
1. 后一相关指令暂停一周斯
2. 资源重复配置：数据存储器+指令存储器

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172041217.png)

#### 2.数据相关
数据冲突：在一个程序中，存在必须等前一条指令执行完才能执行后一条指令的情况
解决办法:
1. 把遇到数据相关的指令及其后续指令都暂停一至几个时钟周期，直到数据相关问题消失后再继续执行。可分为硬件阻塞（stall）和软件插入“NOP”两种方法
2. 旁路技术

硬件插入
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172045263.png)

软件插入
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172045263.png)

数据的基本操作：读（R）、写（W）
冲突的基本类型：RAW、WAR、WAW
- RAW
l1：ADD R5，R2，R4；（R2)+(R4）-> R5
l2：ADD R4，R5，R3；（R5)+(R3) -> R4
- WAR
l1: STA M，R2; (R2)-> M,M为主存单元
l2: ADD R2，R4，R5；(R4)+(R5)->R2
乱序发射，编写程序的时候希望l1在l2前完成，但优化手段导致l2在l1前发射
- WRW
l1: MUL R3，R2，R1；(R2) * (R1)->R3
l2: SUB R3，R4，R5；(R4) - (R5)->R3
存在多个功能部件时，后一条指令可能比前一条指令先完成

#### 3.控制相关
控制冲突：流水线遇到转移指令和其他改变PC值的指令而造成断流
解决办法
1. 尽早判别转移是否发生，尽早生成转移目标地址
2. 预取转移成功和不成功两个控制流方向上的目标指令
3. 加快和提前形成条件码
4. 提高转移方向的猜准率

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172051957.png)


### 4.流水线性能
流水线性能通常用吞吐率、加速比和效率3项指标衡量。

#### 1. 吞吐率
吞吐率：指在单位时间内流水线所完成的任务数量，或是输出结果的数量
设任务数为n，处理完成n个任务所用的时间为$T_{K}$ ,
$$流水线吞吐率TP最基本的公式为TP=\frac{n}{{T_{k}}}$$
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172011083.png)

理想情况
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172014283.png)
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172016490.png)

$T_{k}=(k+n-1)\Delta t$
流水线的实际吞吐率为 $TP=n/{((k+n-1)\Delta t)}$  

#### 2. 加速比
完成同样一批任务，不使用流水线所用的时间与使用流水线所用的时间之比
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172021015.png)

#### 3.效率：
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172022648.png)

当连续输入的任务n趋近于无穷时，最高效率$E_{max}=1$ 

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172024805.png)

### 5.流水线多发技术
**1.超标量技术**
：指在每个时钟周期内可同时并发多条独立指令，即以并行操作方式将两条或两条以上指令编译执行。
- 每个时钟周期内可并发多条独立指令
- 要配置多个功能部件
- 不能调整指令的执行顺序
- 通过编译优化技术，把可并行执行的指令搭配起来

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172107987.png)

**2.超流水技术**
：将一些流水线寄存器插入流水线段中
- 在一个时钟周期内再分段（3段）
- 在一个时钟周期内一个功能部件使用多次（3次）
- 不能调整指令的执行顺序
- 靠编译程序解决优化问题

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172111550.png)

**3.超长指令字技术**
超长指令字技术和超标量技术都是采用多条指令在多个处理部件中并行处理的体系结构，在一个时钟周期内能流出多条指令。
- 由编译程序挖掘出指令间潜在的并行性
- 将多条能并行操作的指令组合成一条
- 具有多个操作码字段的超长指令字（可达几百位）

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202211172114188.png)




### 6.流水线分类
**1. 部件功能级、处理机级和处理机间级流水线**
根据流水线使用的级别的不同，流水线可分为部件功能级流水线、处理机级流水线和处理机间流水线。
- 部件功能级流水：将复杂的算术逻辑运算组成流水线工作方式。例如，可将浮点加法操作分成求阶
差、对阶、尾数相加以及结果规格化等4个子过程。
- 处理机级流水：把一条指令解释过程分成多个子过程，如前面提到的取指、译码、执行、访存及写回5
个子过程
- 处理机间流水：一种宏流水，其中每一个处理机完成某一专门任务，各个处理机所得到的结果需存放
在与下一个处理机所共享的存储器中。

**2.单功能流水线和多功能流水线**
按流水线可以完成的功能，流水线可分为单功能流水线和多功能流水线。
单功能流水线：指只能实现一种固定的专门功能的流水线
多功能流水线：指通过各段间的心同连接方式可以同时或不同时地实现多种功能的流水线

**3.动态流水线和静态流水线**
按同一时间内各段之间的连接方式，流水线可分为静态流水线和动态流水线
- 静态流水线：指在同一时间内，流水线的各段只能按同一种功能的连接方式工作。
- 动态流水线：指在同一时间内，当某些段正在实现某种运算时，另一些段却正在进行另一种运算。这样对提高流水线的效率很有好处，但会使流水线控制变得很复杂。

**4.线性流水线和非线性流水线**
按流水线的各个功能段之间是否有反馈信号，流水线可分为线性流水线与非线性流水线
- 线性流水线：从输入到输出，每个功能段只允许经过一次，不存在反馈回路·
- 非线性流水线：存在反馈回路，从输入到输出过程中，某些功能段将数次通过流水线，这种流水线适合进行线性递归的运算。


# 8.4 中断系统
