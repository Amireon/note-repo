`文件`: 一组有意义的数据集合
1. 计算机中存放了各种各样的文件，一个文件有哪些属性？
	- 文件内部的数据应该怎样组织起来？
	- 文件之间又应该又应该怎么组织起来？
2. 从下往上看,OS应提供哪些功能，才能方便用户、应用程序使用文件?
3. 从上往下看，文件数据应该怎么存放在外存（磁盘）上?

**一个文件有哪些属性？**
- `文件名`：由创建文件的用户决定文件名，主要是为了方便用户找到文件，同一目录下不允许有重名文件
- `标识符`：一个系统内的各文件标识符唯一，对用户来说毫无可读性因此标识符只是操作系统用于区分各个文件的一种内部名称
- `类型`：指明文件的类型
- `位置`：文件存放的路径（让用户使用）、在外存中的地址（操作系统使用，对用户不可见
- `大小`：指明文件大小
- `创建时间`
- `上次修改时间`
- `文件所有者信息`
- `保护信息`：对文件进行保护的访问控制信息

**操作系统向上提供的功能**
- 创建文件(create系统调用)
- 删除文件(delete系统调用)
- 读文件(read系统调用)
- 写文件(write系统调用)
- 打开文件(open系统调用)
- 关闭文件(close系统调用)

**文件如何存放在外存**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301171917112.png)

## 4.1 文件
### 1.文件的逻辑结构
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301171919358.png)

按文件是否有结构分类，可以分为无结构文件、有结构文件两种。
- `无结构文件`：文件内部的数据就是一系列二进制流或字符流组成。又称“流式文件”。如Windows操作系统中的.txt 文件。
- `有结构文件`: 由一组相似的记求组成，又称“记录式文件”。每条记录又右十个数据项组成, 如数据库表文件。一般来说，每条记录有一个数据项可作为关键字。根据各条记录的长度(占用的存储空间)是否相等，划分为定长记录和可变长记录两种

**1.顺序文件**
`顺序文件`：文件中的记录一个接一个顺序排列(逻辑上)，记录可以是定长的也可以是可边长的，各个记录在物理上顺序存储或链式存储
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301171926730.png)

顺序文件的两种结构:
- `串结构`: 记录之间的顺序与关键字无关
- `顺序结构`: 记录之间的顺序按关键字顺序排列

假设: 已经知道了文件的起始地址（也就是第一个记录存放的位置）
- 思考1: 能否快速找到第i个记录对应的地址？（即能否实现随机存取）
- 思考2: 能否快速找到某个关健字对应的记录存放的位置？

链式存储：无论是定长河变长记录，都无法实现随机存取，每次只能从第一个记录开始依次往后查找
顺序存储：
- 可变长记录：无法实现随机存取。每次只能从第一个记录开始依次往后查找
- 定长记录：可实现随机存取。记录长度为L，则第i个记录存放的相对位置是`i*L`
	- 若采用串结构，无法快速找到某关键字对应的记录
	- 若采用顺序结构，可以快速找到某关键字对应的记录（如折半查找)

结论：定长记录的顺序文件，若物理上采用顺序存储，则可实现随机存取：若能保证记录的顺序结构，则可实现快速检索(即根据关键字快速找到对应记录）

> 考试题目中的”顺序文件“指物理上的顺序存储的顺序文件


**2.索引文件**
素引表本身是定长记录的顺序文件。因此可以快速找到第i个记录对应的索引项。
可将关键字作为索引号内容，若按关键字顺序排列，则还可以支持按照关键字折半查找。每当要增加/删除一个记录时，需要对索引表进行修改。由于索引文件有很快的检索速度，因此主要用于对信息处理的及时性要求比较高的场合
可以用不同的数据项建立多个索引表。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301171958306.png)

**3.索引顺序文件**
> 思考索引文件的缺点：每个记录对应一个索引表项，因此索引表可能会很大
 比如：文件的每个记录平均只占8B，而每个索引表项占32个字节，那么索引表都要比文件内容本身大4倍，这样对存储空间的利用率就太低了。

- 索引顺序文件是索引文件和顺序文件思想的结合。
- 为文件建立一张索引表，但一组记录对应一个索引表项

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172001953.png)

为了进一步提高检索效率，可以为顺序文件建立多级索引表

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172002333.png)


### 2.文件目录
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172005151.png)

#### 文件控制块
- FCB的有序集合称为“文件目录”，一个FCB就是一个文件目录项
- FCB中包含了文件的基本信息（文件名、物理地址、逻辑结构、物理结构等），存取控制信息（是否可读/可写、禁止访问的用户名单等），使用信息（如文件的建立时间、修改时间等）。
- 最基本的还是文件名、文件存放的物理地址。

需要对目录进行哪些操作？
- `搜索`：当用户要使用一个文件时，系统要根据文件名搜索目录，找到该文件对应的目录项
- `创建文件`：创建一个新文件时，需要在其所属的目录中增加一个目录项
- `删除文件`：当删除一个文件时，需要在目录中删除相应的目录项
- `显示目录`：用户可以请求显示目录的内容，如显示该目录中的所有文件及相应属性
- `修改目录`：某些文件属性保存在目录中，因此这些属性变化时需要修改相应的目录项

#### 目录结构
**1.单级目录结构**
- 早期操作系统并不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项
- 单级目录实现了“按名存取”，但是不允许文件重名
- 在创建一个文件时，需要先检查目录表中有没有重名文件，确定不重名后才能允许建立文件，并将新文件对应的目录项插入目录表中。
- 单级目录结构不适用于多用户操作系统

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172012492.png)


**2.两级目录结构**
早期的多用户操作系统，采用两级目录结构。分为主文件目录（MFD，Master File Directory）和用户文件目录（UFD，User Flie Directory）。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172014802.png)


**3.多级目录结构**
又称树形目录结构
- 用户（或用户进程）要访问某个文件时要用文件路径名标识文件，文件路径名是字符串。各级目录之间用“/”隔开。从根目录出发的路径称为绝对路径
- 文件分类，层次结构清晰，有效管理和保护文件
- 树形结构不便于实现文件共享。

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172015640.png)

**4.无环图目录结构**

- 可以用不同的文件名指向同一个文件，甚至可以指向同一个目录（共享同一目录下的所有内容）。
- 需要为每个共享结点设置一个共享计数器，用于记录此时有多少个地方在共享该结点。用户提出删除结点的请求时，只是删除该用户的FCB、并使共享计数器减1，并不会直接删除共享结点。只有共享计数器减为0时，才删除结点。
- 共享文件不同于复制文件。在共享文件中，由于各用户指向的是同一个文件，任何一个用户修改了文件数据，那么所有用户都可以看到文件数据的变化

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202301172019093.png)

#### 索引结点
索引结点是FCB的改进
在查找各级目录的过程中只需使用“文件名”，只有文件名匹配时，才需要读出文件的其他信息。因此可以考虑让目录表“瘦身”来提升效率。

- 当找到文件名对应的目录项时，才需要将索引结点调入内存，索引结点中记录了文件的各种信息，包括文件在外存中的存放位置，根据“存放位置”即可找到文件
- 存放在外存中的索引结点称为“磁盘索引结点”，当索引结点放入内存后称为“内存索引结点”相比之下内存索引结点中需要增加一些信息，比如：文件是否被修改、此时有几个进程正在访问该文件等

### 3.文件的物理结构
操作系统对磁盘块进行的管理：
- 对非空闲磁盘块的管理
- 对空闲磁盘块的管理

文件的物理结构(文件分配方式)
- 连续分配
- 链接分配：隐式链接、显式链接
- 索引分配

**文件块、磁盘块**
- 类似于内存分页，磁盘中的存储单元也会被分为一个个“块/磁盈块/物理块”。很多操作系统中，磁盘块的大小与内存块、页面的大小相同
- 内存与磁盘之间的数据交换(读写操作，磁盘I/O)以块为单位
- 在内存管理中，进程的逻辑地址空间被分为一个一个页面
- 在外存管理中，为了方便对文件数据的管理，文件的逻辑地址空间也被分为了一个一个的文件“块”。
- 文件的逻辑地址可以表示为（逻辑块号，块内地址）的形式

