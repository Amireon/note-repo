## 3.1 概述和传输层服务



## 3.2 多路复用和解复用
解复用作用：TCP或者UDP实体采用哪些信息，将报文段的数据部分交给目标socket和进程

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272008209.png)

### 多用复用工作原理
主机收到IP数据报，主机联合使用**IP地址和端口号**将报文发送给目标socket
- 每个数据报有源IP和目标地址
- 每个数据报承载一个传输层报文段
- 每个报文段有一个源端口号和目标端口号
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272016000.png)

### 无连接(UDP)的多路解复用
创建socket：
服务器端：serverSocket和sad指定的端口号绑定
```c
serverSocket = socket(PF_INET,SOCK_DGRAM,0);
bind(serverSocket,&sad,sizeof(sad));
```

客户端：
```c
clientSocket = socket(PF_INET,SOCK_DGRAM,0);
```

- 在接收端，UDP Socket使用二元组标识：（目标IP地址，目标端口号）
- 当主机收到UDP报文段，检查报文段的目标端口号，用该端口号将报文段定位给socket
- 如果两个不同源IP地址/源端口号的数据报，但是有相同的目标IP地址和端口号，则被定位到相同的socket

无连接多路复用举例
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272022028.png)

### 面向连接(TCP)的多路复用
TCP套接字：四元组标识，（源IP地址，源端口号，目的IP地址，目的端口号）
- 服务器能够在一个TCP端口上同时支持多个TCP套接字
- Web服务器对每个了解客户端又不用的socket，非持久对每个请求有不同的socket

**面向连接的解复用例子**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272032812.png)

**多线程Web Server**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272033407.png)

## 3.3 无连接传输:UDP
**UDP(User Datagram Protocol)**
- “尽力而为”的服务：报文段可能丢失，乱序
- 无连接：UDP发送端和接收端之间没有握手；每个UDP报文段都被独立处理
- 被用于流媒体、DNS、SNMP等
- 在UDP上可行可靠传输：在应用层增加可靠性；应用特定的差错恢复

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272038897.png)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212272039387.png)

## 3.4 可靠数据传输的原理
可靠数据传输（rdt）在应用层、传输层和数据链路层，信道的不可靠特点决定了rdt的复杂性
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212281504717.png)

**问题描述**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212281511962.png)




## 3.5 面向连接的传输：TCP
### 段结构
**TCP概述**
- 点对点：一个发送方、一个接收方
- 可靠的、按顺序的字节流：没有报文边界
- 管道化（流水线）：TCP拥塞控制和流量控制设置窗口大小
- 发送和接收缓存
- 全双工数据：同一连接中数据流双向流动；MSS最大报文段大小
- 面向连接：在数据交换之前，通过握手（交换控制报文）初始化发送方、接收方的状态变量
- 有流量控制：发送方不会淹没接收方

#### TCP报文段结构
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212291920187.png)

**TCP序号、确认号**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212291959929.png)

#### TCP往返延时RTT和超时
**1.如何设置TCP超时？**
- 比RTT长，但是RTT是变化的
- 太短：太早超时，造成重传
- 太长：对报文段丢失反应太慢

**2.如何估计RTT？**
- SampleRTT：测量从报文段发出到收到确认的时间，如果有重传，则忽略此次测量
- SampleRTT会变化，估计的RTT应该比较平滑，对几个最近的测量取平均值

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212292008455.png)

**设置超时**
- EstimatedRTT+安全边界时间：EstimtedRTT变化大（方差大）则有较大的安全边界时间
- SampleRTT偏离EstimatedRTT的距离：
$DevRTT = (1-a) * DevRTT + a *  | SampleRTT - EstimatedRTT|$，a推荐值为0.25

**超过时间间隔设置为：**
$TimeoutInterval = EstimatedRTT + 4 * DevRTT$

### 可靠数据传输
1. TCP在IP不可靠服务的基础上建立了RDT：
	- 管道化的报文段GBN或SR；
	- 累积确认，GBN
	- 单个重传定时器，GBN
	- 是否接收乱序

 2. 触发重传事件：
	- 超时：只重发最早的未确认的段，SR
	- 重复的确认：如收到了ACK50，之后又收到3个ACK50

3. 首先考虑简化的TCP发送方：
	- 忽略重复的确认
	- 忽略流量控制和拥塞控制

 #### TCP发送方


 ![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202212292020382.png)

