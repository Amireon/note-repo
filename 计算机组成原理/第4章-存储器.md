# 第4章 存储器

## 4.1 存储器的基本概念
### 1.存储器的分类
**1.按存储介质**
|   存储介质   |                组成器件                | 是否易失 |
| :----------: | :------------------------------------: | :------: |
| 半导体存储器 | TTL（高速）、MOS（高集成度、成本低廉） |   易失   |
| 磁表面存储器 |              磁头、载磁体              |  非易失  |
|  磁芯存储器  |           硬磁材料、环状元件           |  非易失  |
|  光盘存储器  |             激光、磁光材料             |  非易失  |

**2.按存取方式**
随机访问: 存取时间与存储单元所在位置无关
- 随机存储器：在程序执行过程中可读写
- 只读存储器：在程序执行过程中只读

串行访问: 存取时间与存储单元所在位置有关
- 顺序存取存储器：磁带
- 直接存取存储器：磁盘

**3.按作用(层次)**
- 主存储器：可以和 CPU 直接交换信息，多使用DRAM
- 高速缓冲存储器（Cache）: 使用SRAM
- 辅助存储器：主存储器的后院存储器，存放暂时不用的程序和数据，不能和 CPU 直接交换数据

> RAM 的分类：按存储信息原理的不同，
> - SRAM 以触发器原理存储信息
> - DRAM 以电容充放电原理存储信息


![image-202302011723775](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011723775.png)


### 2.存储器的层次化结构
- 寄存器中的数直接在CPU内部参与运算
- 主存存放将要参与运行的程序和数据
- 高速缓冲存储器比主存速度更快，容量更小

从寄存器、缓存、主存、到辅存，
- 位价越来越低，
- 速度越来越慢，
- 容量越来越大，
- CPU访问频率越来越低

**存储系统层次化结构**
- 缓存-主存层次：解决 CPU 和主存速度不匹配的问题
- 主存-辅存层次：解决存储系统的容量问题

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011729024.png)

主存-辅存的发展形成了虚拟存储系统
- 指令地址称为虚地址或逻辑地址等
- 主存的实际地址称为物理地址或实地址


## 4.2 主存储器
### 1. 主存概述   
**存储单元地址的分配**
存储字与存储字长，存储字的长度是存储字长
按字节寻址的范围与地址线根数有关，按字寻址的范围与地址线根数和存储字长有关

设地址线 N 根，存储字长为 M 位，
- 按字节寻址（直接寻址）的范围是 2<sup>N</sup>
- 按照字寻址的范围是 2<sup>N</sup> /  (M / 8), (M / 8)是存储字的个数

>例：地址线24根，按字节寻址16M；若此时字长为16位，按字寻址的范围是8M

**主存的技术指标**
存取时间：又称存储器的访问时间，指启动一次存储器操作(读或写)到完成该操作所需的全部时间
存取周期：连续两次独立的存储器操作所需的最小间隔时间

- 存储容量：存储单元个数 * 存储字长
- 存储器带宽：数据传输率，存储字长 / 存取周期

提高存储器带宽的措施
- 缩短存取周期
- 增加存储字长
- 增加存储体

### 2. 半导体随机存取芯片                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
**1. 半导体存储芯片的基本结构**

- 存储矩阵：由大量相同的位存储单元阵列构成
- 译码驱动：将来自地址总线的地址信号翻译成对应存储单元的选通信号，该信号在读写电路的配合下完成对被选中单元的读/写操作
- 读写电路：包括读出放大器和写入电路，用来完成读/写操作。
- 读/写控制线: 决定芯片进行读/写操作
- 地址线：单向输入，位数与存储字个数有关
- 数据线：双向，位数与数据位数有关
- 数据线数与地址线数反映存储器容量大小：地址线M根；数据线N根，那么芯片容量 = 2<sup>M</sup> * N 位

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011818485.png)


**2.半导体存储存储芯片的译码驱动方式** 
- 线选法：用一根字选择线直接选中一个存储单元的各位，结构简单，适用于容量不大的存储芯片 
- 重合法：使用X，Y两个方向，经过译码器，形成控制信号   

### 3.随机存取存储器RAM
两类RAM的信息存储原理：
- 静态RAM：触发器，信息读出后保持原状态，断电原有信息丢失
- 动态RAM：电容储存电荷，即使不断电信息也会丢失，需要再生或刷新

|  比较项目  | SRAM(缓存) | DRAM（主存） |
| :--------: | :--------: | :----------: |
|  存储原理  |   触发器   |     电容     |
| 破坏性读出 |     非     |      是      |
|   集成度   |     低     |      高      |
|  芯片引脚  |     多     |      少      |
|    功耗    |     大     |      小      |
|    价格    |     高     |      低      |
|    速度    |     快     |      慢      |
|    刷新    |     无     |      有      |

![image-202302011933237](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011933237.png)


### 4.DRAM的刷新
- 多久刷新一次：刷新周期，一般为2ms
- 每次刷新多少存储单元：以行为单位，使用行列地址原因：减少选通线的数量
- 如何刷新：有硬件支持，读出一行的信息后重新写入，占用1个读/写周期
- 在什么时刻刷新：集中刷新，分散刷新，异步刷新

假设存储芯片是128行 * 128列矩阵，存取周期（读/写周期）为0.5us, 2ms/0.5us=4000个周期

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302011953239.png)

| 刷新方式 | 优缺点                                     | 刷新时间间隔 |
| -------- | ---------------------------------------- | -------- |
| 集中刷新 | 存在死区，此时无法进行读写操作 |        |
| 分散刷新 | 不存在死区，存取时间延长，系统速度降低，存取周期变为1us  |  128个存取周期即128us |
| 异步刷新 | 不存在死区，不会延长存取时间           |     2ms     |


### 5.只读存储器ROM
- ROM: 结构简单，位密度比RAM高；非易失性，可靠性高；起初只能读，现在可写
- 只读存储器（ROM）：PROM，EPROM，EEPROM等
- 半导体ROM的基本器件分为两种：MOS型和TTL型

- 掩膜式只读存储器(MROM): 存储内容由半导体制造厂按用户提出的要求, 在芯片的生产过程中直接写入，无法修改
- 一次可编程只读存储器(PROM): 存储内容由用户用专门的设备(编程器)一次性写入，之后无法修改
- 可擦除可编程只读存储器(EPROM): 紫外线擦除(UVEPROM),电擦除(EEPROM),修改次数有限,写入时间很长
- 闪速存储器(Flash Memory): 如U盘，写入速度较快
- 固态硬盘(Solid State Drives): 控制单元十FLASH芯片

| 类型    |                                      |                     |
| ------- | ------------------------------------ | ------------------- |
| 掩模ROM | 重合法驱动，用户无法改变原始数据状态 | 行列交叉处有无MOS管 |
| PROM    | 一次性编程的只读存储器               |  熔丝断和未断    |
| FPROM   | 可擦除可编程只读存储器               |     |

EPROM的改写：
- 紫外线照射：擦除时间较长，且不支持对个别单元进行单独擦除
- 电气法：字擦除或页擦除方式，可局部擦除和全部擦除，EEPROM

闪速存储器（Flash Memory），
- 兼有EPROM的价格便宜，集成度高和EEPROM电可擦除重写的特性
- 整片擦除的特点，擦除、重写速度快
- 存储器访问周期短，功耗低，计算机接口简单

### 6.存储器与CPU的连接
单片存储芯片的容量是有限的，将若干存储芯片连接在一起组成足够容量的存储器，称为存储容量的扩展，通常有字扩展和位扩展，宁愿位扩展不选字扩展

| 扩展方式 | 含义               | 示例                  | 重点 |
| -------- | ------------------ | --------------------- | ---- |
| 位扩展   | 增加存储字长 | 2片1Kx4位 = 1片1Kx8位 |   数据线，同时访问   |
| 字扩展   | 增加存储字的数量   | 2片1Kx8位 = 1片2Kx8位 |   地址线，单独访问   |

无论是哪种扩展方式，最重要的都是片选线的连接（片选信号的形成）


![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302012025218.png)

**例题**
![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302012026423.png)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302012026449.png)

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302012027459.png)


### 7.提高访存速度的措施
- 采用高速器件
- 采用层次结构
- 调整主存结构(本小节)

**1.单体多字系统**
- 前提：指令和数据在主存内是连续存放的
- 每个存储单元存储m个字
- 总线宽度为m个字
- 一次并行读出m个字
- 限制：指令和数据必须是连续存放的

**2.多体并行系统**
- 每个模块都有相同的容量和存取速度
- 各模块都有独立的读写控制电路、地址寄存器和数据寄存器。

假设每个体的存储字长和数据总线的宽度一致，低位交叉的存储器模块数为n，存取周期为T，总线传输周期为t，
| 交叉编址方式         | 特点           | 连续读取n个字所需时间 |
| -------------------- | -------------- | --------------------- |
| 高位交叉编址（顺序存储） | 各个体并行工作 |   nT              |
| 低位交叉编址（交叉存储）  | 各个体轮流编址 |  T + (n - 1)t     |

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302012043370.png)


## 4.3 高速缓冲存储器

- 缓存-主存层解决主存与CPU速度不匹配
![](https://raw.githubusercontent.com/Anlieh/PicBucket/master/202210051846681.png)
- 程序的局部性原理

程序的局部性原理
- 空间局部性：指令和数据在主存内是连续存放的
- 时间局部性：在最近要使用的信息，可能是现在正在使用的信息

### 1.Cache的工作原理
**1. 主存与缓存的编址**
主存由2<sup>n</sup>个可编址的字组成，每个字有唯一的n位地址
主存地址分为两段：高m位表示主存的块地址，低b位表示块内地址，2<sup>m</sup>表示主存的块数
Cache地址分为两段：高c位表示缓村的块号，低b位表示块内地址，z<sup>c</sup>表示Cache块数

- CPU与Cache一次传送一个字
- Cache与主存是字块传送
![](https://raw.githubusercontent.com/Anlieh/PicBucket/master/202210051849603.png)

**2.Cache的性能分析**
CPU欲读取主存某字时，有两种情况：
- 所需的字已在Cache中，称CPU访问Cache命中
- 所需的块在不在Cache中，称CPU访问Cache不命中

三个评估指标
- 命中率 = 访问Cache的总命中次数 / (访问Cache的总命中次数+访问主存的总次数)
- 平均访问时间 = 命中率 * Cache访问时间 + (1 - 命中率) * 主存访问时间
- 访问效率 = Cache访问时间 / 平均访问时间

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302012056494.png)


### 2.Cache的基本结构
**Cache的基本结构**
![](https://raw.githubusercontent.com/Anlieh/PicBucket/master/202210051904690.png)

**Cache的读写操作**

**写操作：** 对Cache块内写入的信息，必须与被映射主存块内的信息保持一致
| 方式                      | 含义                                                                        | 写操作时间      | 特点                                                                     |
| ------------------------- | --------------------------------------------------------------------------- | --------------- | ------------------------------------------------------------------------ |
| 写直达法（Write-through） | 写操作时数据既写入Cache又写入主存                                           | 访问主存的时间  | 读操作时不涉及对主存的操作，更新策略较易实现                             |
| 写回法（Write-back）      | 写操作时只把数据写入 Cache 而不写入主存 当 Cache 数据被替换出去时才写回主存 | 访问Cache的时间 | 读操作Cache失效发生数据替换时，被替换的块需写回主存，使用清浊标记Cache内容是否变化，增加了Cache的复杂性 |

**Cache的改进**
- 增加Cache的级数：片内Cache，片外Cache
- 统一缓存和分立缓存：指令Cache，数据Cache；与主存结构有关；与指令执行的控制方式有关；是否流水


### 3. Cache-主存地址映射
由主存地址映射到Cache地址分为地址映射，三种映射方式：直接映射，全相连映射，组相连映射

**（1）直接映射**
- 每个主存块只与一个缓存块对应，i = j mod C, i为缓存块号，j为主存块号，C为缓存块数
- 某一主存块只能固定映射到某一缓存块
- 优点：只需利用主存地址的某些位直接判断即可确定所需字块是否在缓存中
- 缺点：每个主存块只能对应某个缓存块，Cache利用率低；可能频繁替换缓存信息
- 主存地址格式：主存字块标记 + Cache字块地址 + 字块内地址
- 主存字块标记 + Cache字块地址 = log2 主存字块数量

**（2）全相连映射**
- 全相连映射允许主存每一字块映射到Cache中的任何一块位置上。
- 某一主存块能映射到任一缓存块
- 优点：灵活，命中率高，快冲突率低
- 缺点：所需逻辑电路多，成本较高
- 主存地址格式：主存字块标记 + 字块内地址


**（3）组相连映射**
- 组相连映射是直接映射和全相连映射的折中。
- 某一主存块能映射到某一缓存组中的任一块
- 主存地址格式：主存字块标记 + 组地址 + 字块内地址
- 组地址： 对Cache能分成的组的数量编址，log2 Cache能分成的组,

![](https://ypic.oss-cn-hangzhou.aliyuncs.com/202302021155499.png)

### 4.Cache替换策略
当新的主存块需要调入Cache，而目标Cache块被占满，需要替换掉Cache中的数据。替换策略面向全相连和组相连

**1.先进先出(FIFO)算法**
- 选择最早调入的行进行替换。它比较容易实现，但也没有依据程序访问的局部性原理，可能会把一些需要经常使用的程序块（如循环程序）也作为最早进入Cache的块替换掉。
- 优点：容易实现，开销小
- 缺点：不根据局部性原理，无法提高Cache的命中率

**2.近期最少使用（LRU）算法**
- 依据程序访问的局部性原理选择近期内长久未访问过的存诸行作为替换的行，平均命中率要比FIFO要高，是堆枝类算法
- LRU算法对每行设置一个计数器，Cache每命中一次，命中行计数器清0，而其他各行计数器均加1，需要替换时比较各特定行的计数值，将计数值最大的行换出
- 使用访存局部性原理，平均命中率比FIFO高

**3.随机法**
- 随机地确定替换的Cache块。它的实现比较简单，但没有依据程序访问的局部性原理，命中率较低
- 采用一个随机数产生器产生一个随机数替换块，无法提高Cache命中率

**4.最不经常使用算法(LFU)**
- 将一段时间内被访问次数最少的存储行换出。每行也设置一个计数器，新行建立后从0开始计数，每访问一次，被访问的行计数器加1，需要替换时比较各特定行的计数值,将计数值最小的行换出

## 4.4 辅助存储器
概述：
![](https://raw.githubusercontent.com/Anlieh/PicBucket/master/202210051943084.png)

### 1.硬磁盘存储器
**分类**：固定磁头和移动磁头；可换盘和固定盘
存储器存储结构

**（1）磁盘驱动器**
![](https://raw.githubusercontent.com/Anlieh/PicBucket/master/202210051946248.png)

**（2）磁盘控制器**
磁盘控制器是主机与磁盘驱动器之间的接口：对主机通过总线，对硬盘（设备）
- 接收主机发来的命令，转换成磁盘驱动器的控制命、
- 实现主机和驱动器之间的数据格式转换
- 控制磁盘驱动器读写

### 2.软磁盘存储器
软盘由聚脂薄膜制成

硬盘与软盘的比较
| 比较项目 | 硬盘                     | 软盘           |
| -------- | ------------------------ | -------------- |
| 速度     | 快                       | 慢             |
| 磁头     | 固定、活动；浮动         | 活动；接触盘片 |
| 盘片     | 固定盘、盘组大部分不可换 | 可换盘片       |
| 价格     | 高                       | 低             |
| 环境     | 苛刻                         |                |

### 3.光盘存储器
**原理**：采用光存储技术，利用激光写入和读出
- 第一代光存储技术，采用非磁性介质，不可擦写
- 第二代光存储技术，采用磁性介质，可擦写

**光盘的存储原理：**
- 只读型和只写一次型：热作用（物理或化学变化）
- 可擦写光盘：热磁效应

## 本章考研大纲
1. 存储器的分类
2. 存储器的层次化结构
3. 半导体随机存取存储器
	- SRAM的工作原理
	- DRAM的工作原理
1. 只读存储器
2. 主存储器与CPU的链接
3. 多模块存储器
4. 高速缓冲存储器
	- 程序访问的局部
	- Cache的基本工作原理
	- Cache和主存之间的映射方式

 